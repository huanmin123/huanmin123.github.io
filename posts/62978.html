<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="utf-8"><meta name="keywords" content="Eureka,负载均衡Ribbon,熔断器Hystrix,Feign声明式客服端,集群,Zuul服务网关,Gateway,Git配置管理,消息总线"><meta name="description" content=""><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="renderer" content="webkit|ie-stand|ie-comp"><meta name="mobile-web-app-capable" content="yes"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><title>SpringCloud微服务入门 | 码虫</title><link rel="icon" type="image/x-icon, image/vnd.microsoft.icon" href="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/Login/favicon.ico"><link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css"><link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css"><link rel="stylesheet" type="text/css" href="/libs/aos/aos.css"><link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css"><link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css"><link rel="stylesheet" type="text/css" href="/css/matery.css"><link rel="stylesheet" type="text/css" href="/css/my.css"><script src="/libs/jquery/jquery.min.js"></script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="码虫" type="application/atom+xml"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"><link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head><body><header class="navbar-fixed"><nav id="headNav" class="bg-color nav-transparent"><div id="navContainer" class="nav-wrapper container"><div class="brand-logo"><a href="/" class="waves-effect waves-light"><div><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/Login/Login.png" class="logo-img" alt="LOGO"> <span class="logo-span">码虫</span></div></a></div><a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a><ul class="right nav-menu"><li class="hide-on-med-and-down nav-item"><a href="/" class="waves-effect waves-light"><i class="fas fa-home" style="zoom:.6"></i> <span>主页</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fas fa-tags" style="zoom:.6"></i> <span>标签</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fas fa-bookmark" style="zoom:.6"></i> <span>分类目录</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fas fa-archive" style="zoom:.6"></i> <span>档案</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/about" class="waves-effect waves-light"><i class="fas fa-user-circle" style="zoom:.6"></i> <span>关于我</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/contact" class="waves-effect waves-light"><i class="fas fa-comments" style="zoom:.6"></i> <span>联系</span></a></li><li><a href="#searchModal" class="modal-trigger waves-effect waves-light"><i id="searchIcon" class="fas fa-search" title="搜索" style="zoom:.85"></i></a></li></ul><div id="mobile-nav" class="side-nav sidenav"><div class="mobile-head bg-color"><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/Login/Login.png" class="logo-img circle responsive-img"><div class="logo-name">码虫</div><div class="logo-desc">Never really desperate, only the lost of the soul.</div></div><ul class="menu-list mobile-menu-list"><li class="m-nav-item"><a href="/" class="waves-effect waves-light"><i class="fa-fw fas fa-home"></i> 主页</a></li><li class="m-nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fa-fw fas fa-tags"></i> 标签</a></li><li class="m-nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fa-fw fas fa-bookmark"></i> 分类目录</a></li><li class="m-nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fa-fw fas fa-archive"></i> 档案</a></li><li class="m-nav-item"><a href="/about" class="waves-effect waves-light"><i class="fa-fw fas fa-user-circle"></i> 关于我</a></li><li class="m-nav-item"><a href="/contact" class="waves-effect waves-light"><i class="fa-fw fas fa-comments"></i> 联系</a></li><li><div class="divider"></div></li><li><a href="https://github.com/" class="waves-effect waves-light" target="_blank"><i class="fab fa-github-square fa-fw"></i>Fork Me</a></li></ul></div></div><style>.nav-transparent .github-corner{display:none!important}.github-corner{position:absolute;z-index:10;top:0;right:0;border:0;transform:scale(1.1)}.github-corner svg{color:#0f9d58;fill:#fff;height:64px;width:64px}.github-corner:hover .octo-arm{animation:a .56s ease-in-out}.github-corner .octo-arm{animation:none}@keyframes a{0%,to{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}</style><a href="https://github.com/" class="github-corner tooltipped hide-on-med-and-down" target="_blank" data-tooltip="Fork Me" data-position="left" data-delay="50"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a></nav></header><div class="bg-cover pd-header post-cover" style="background-image:url(http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/featureimages/518.jpg)"><div class="container" style="right:0;left:0"><div class="row"><div class="col s12 m12 l12"><div class="brand"><h1 class="description center-align post-title">SpringCloud微服务入门</h1></div></div></div></div></div><main class="post-container content"><link rel="stylesheet" href="/libs/tocbot/tocbot.css"><style>#articleContent h1::before,#articleContent h2::before,#articleContent h3::before,#articleContent h4::before,#articleContent h5::before,#articleContent h6::before{display:block;content:" ";height:100px;margin-top:-100px;visibility:hidden}#articleContent :focus{outline:0}.toc-fixed{position:fixed;top:64px}.toc-widget{width:345px;padding-left:20px}.toc-widget .toc-title{margin:35px 0 15px 0;padding-left:17px;font-size:1.5rem;font-weight:700;line-height:1.5rem}.toc-widget ol{padding:0;list-style:none}#toc-content{height:calc(100vh - 250px);overflow:auto}#toc-content ol{padding-left:10px}#toc-content ol li{padding-left:10px}#toc-content .toc-link:hover{color:#42b983;font-weight:700;text-decoration:underline}#toc-content .toc-link::before{background-color:transparent;max-height:25px;position:absolute;right:23.5vw;display:block}#toc-content .is-active-link{color:#42b983}#floating-toc-btn{position:fixed;right:15px;bottom:76px;padding-top:15px;margin-bottom:0;z-index:998}#floating-toc-btn .btn-floating{width:48px;height:48px}#floating-toc-btn .btn-floating i{line-height:48px;font-size:1.4rem}</style><div class="row"><div id="main-content" class="col s12 m12 l9"><div id="artDetail"><div class="card"><div class="card-content article-info"><div class="row tag-cate"><div class="col s7"><div class="article-tag"><a href="/tags/java/"><span class="chip bg-color">java</span> </a><a href="/tags/SpringCloud/"><span class="chip bg-color">SpringCloud</span></a></div></div><div class="col s5 right-align"><div class="post-cate"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/java-Spring%E5%AE%B6%E6%97%8F/" class="post-category">java-Spring家族</a></div></div></div><div class="post-info"><div class="post-date info-break-policy"><i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp; 2020-10-17</div><div class="info-break-policy"><i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp; 24.9k</div><div id="busuanzi_container_page_pv" class="info-break-policy"><i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp; <span id="busuanzi_value_page_pv"></span></div></div></div><hr class="clearfix"><div class="card-content article-card-content"><div id="articleContent"><h1 align="center">SpringCloud微服务入门</h1><p><strong>读此篇前必先去了解 <code>初始SpringCloud微服务</code> 这篇文章 否则 你有可能看不懂</strong></p><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>微服务是一种架构方式，最终肯定需要技术架构去实施。</p><p>微服务的实现方式很多，但是最火的莫过于Spring Cloud了。为什么？</p><ul><li>后台硬：作为Spring家族的一员，有整个Spring全家桶靠山，背景十分强大。</li><li>技术强：Spring作为Java领域的前辈，可以说是功力深厚。有强力的技术团队支撑，一般人还真比不了</li><li>群众基础好：可以说大多数程序员的成长都伴随着Spring框架，试问：现在有几家公司开发不用Spring？SpringCloud与Spring的各个框架无缝整合，对大家来说一切都是熟悉的配方，熟悉的味道。</li><li>使用方便：相信大家都体会到了SpringBoot给我们开发带来的便利，而SpringCloud完全支持SpringBoot的开发，用很少的配置就能完成微服务框架的搭建</li></ul><p>Spring最擅长的就是集成，把世界上最好的框架拿过来，集成到自己的项目中。</p><p>SpringCloud也是一样，它将现在非常流行的一些技术整合到一起，实现了诸如：配置管理，服务发现，智能路由，负载均衡，熔断器，控制总线，集群状态等等功能。其主要涉及的组件包括：</p><ul><li>Eureka：注册中心 (下面会讲)</li><li>Zuul：服务网关 (下面会讲)</li><li>Ribbon：负载均衡 (下面会讲)</li><li>Feign：服务调用 (下面会讲)</li><li>Hystix：熔断器 (下面会讲)</li></ul><p>以上只是其中一部分</p><h2 id="微服务场景模拟"><a href="#微服务场景模拟" class="headerlink" title="微服务场景模拟"></a>微服务场景模拟</h2><p>简单来说 就是 通过地址请求 来获取对应服务内的数据</p><p>我们简单的搭建 一个服务 一个Eureka：注册中心 和 一个消费者</p><p>创建一个 父工程maven项目 然后在此工程下面 创建 3子工程Maven项目</p><p>结构图:</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da11.jpg" alt=""></p><p><strong>父工程 pom.xml</strong></p><pre class="line-numbers language-xml"><code class="language-xml"> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.1.4.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/></span></span> <span class="token comment" spellcheck="true">&lt;!-- lookup parent from repository --></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">></span></span>
        <span class="token comment" spellcheck="true">&lt;!--        JDK--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">></span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring-cloud.version</span><span class="token punctuation">></span></span>Greenwich.SR3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring-cloud.version</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper.starter.version</span><span class="token punctuation">></span></span>2.1.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mapper.starter.version</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mysql.version</span><span class="token punctuation">></span></span>5.1.46<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mysql.version</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span> <span class="token comment" spellcheck="true">&lt;!-- springCloud --></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>${spring-cloud.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">></span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span> <span class="token comment" spellcheck="true">&lt;!-- 通用Mapper启动器 --></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>tk.mybatis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mapper-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>${mapper.starter.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span> <span class="token comment" spellcheck="true">&lt;!-- mysql驱动 --></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>${mysql.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>commons-lang3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="user-service"><a href="#user-service" class="headerlink" title="user_service"></a>user_service</h3><p><strong>我们先来搭建user_service 服务</strong></p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da12.jpg" alt=""></p><p><strong>pom.xml</strong></p><pre class="line-numbers language-xml"><code class="language-xml">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>tk.mybatis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mapper-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

        <span class="token comment" spellcheck="true">&lt;!-- Eureka客户端 --></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>application.yml</strong></p><pre class="line-numbers language-yml"><code class="language-yml"># 设置端口号
server:
  port: 9091

# 设置服务名称  会在Eureka中显示 而且其他方也要用的
spring:
  application:
    name: user-service
# 配置数据库 参数   
  datasource:
    driver-class-name: com.mysql.jdbc.Driver
    url: jdbc:mysql://localhost:3306/springcloud?useUnicode=true&characterEncoding=utf8&autoReconnect=true&failOverReadOnly=false
    username: root
    password: root
#配置 mybatis 的 实体层
mybatis:
  type-aliases-package: com.itheima.user.entity
#向Eureka 中注册实例
eureka:
  client:
    service-url:
      defaultZone: http://127.0.0.1:10086/eureka<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后在mysql中 创建一个springcloud 数据库 下面有 tb_user 表 用于接下来的测试</p><p>tb_user 表</p><p>链接：<a href="https://pan.baidu.com/s/1SlkDfXii8vJkXuxK4_y2gw" target="_blank" rel="noopener">https://pan.baidu.com/s/1SlkDfXii8vJkXuxK4_y2gw</a><br>提取码：1234</p><p><strong>UserController</strong></p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>user<span class="token punctuation">.</span>controller<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>user<span class="token punctuation">.</span>service<span class="token punctuation">.</span>UserService<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>user<span class="token punctuation">.</span>entity<span class="token punctuation">.</span>User<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Autowired<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>*<span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> UserService userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/{id}"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> User <span class="token function">queryById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> Long id<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        User user <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">queryById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> user<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>User</strong></p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>user<span class="token punctuation">.</span>entity<span class="token punctuation">;</span>

<span class="token keyword">import</span> lombok<span class="token punctuation">.</span>Data<span class="token punctuation">;</span>
<span class="token keyword">import</span> tk<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>KeySql<span class="token punctuation">;</span>

<span class="token keyword">import</span> javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span>Id<span class="token punctuation">;</span>
<span class="token keyword">import</span> javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span>Table<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>Serializable<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Date<span class="token punctuation">;</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"tb_user"</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//直接和数据库中的表绑定</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Id</span>    <span class="token comment" spellcheck="true">//指定id   等会下面会用到</span>
    <span class="token annotation punctuation">@KeySql</span><span class="token punctuation">(</span>useGeneratedKeys <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>  
    <span class="token keyword">private</span> Long id<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 用户名</span>
    <span class="token keyword">private</span> String userName<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 密码</span>
    <span class="token keyword">private</span> String password<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 姓名</span>
    <span class="token keyword">private</span> String name<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 年龄</span>
    <span class="token keyword">private</span> Integer age<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 性别，1男性，2女性</span>
    <span class="token keyword">private</span> Integer sex<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 出生日期</span>
    <span class="token keyword">private</span> Date birthday<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 创建时间</span>
    <span class="token keyword">private</span> Date created<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 更新时间</span>
    <span class="token keyword">private</span> Date updated<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 备注</span>
    <span class="token keyword">private</span> String note<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//自己 添加  get  set    和 toString</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>UserMapper</strong></p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>user<span class="token punctuation">.</span>mapper<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>user<span class="token punctuation">.</span>entity<span class="token punctuation">.</span>User<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span>Mapper<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span>Repository<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Mapper</span>  <span class="token comment" spellcheck="true">// 自动生成 此接口的实例类</span>
<span class="token annotation punctuation">@Repository</span>  <span class="token comment" spellcheck="true">//将实例类 注册到 容器里</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserMapper</span> <span class="token keyword">extends</span> <span class="token class-name">tk<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span>common<span class="token punctuation">.</span>Mapper</span><span class="token operator">&lt;</span>User<span class="token operator">></span><span class="token punctuation">{</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>想要了解更多Mapper接口的用法</p><p>参考 <a href="http://boke.huitoushian.cn/undefined/52900.html#searchModal">http://boke.huitoushian.cn/undefined/52900.html#searchModal</a> 这篇文章 使用注解的方式(进阶)</p><p>以及 <a href="http://boke.huitoushian.cn/undefined/51705.html#toc-heading-11">http://boke.huitoushian.cn/undefined/51705.html#toc-heading-11</a> 这篇文章 里的dao层</p><p><strong>UserService</strong></p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>user<span class="token punctuation">.</span>service<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>user<span class="token punctuation">.</span>entity<span class="token punctuation">.</span>User<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>user<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span>UserMapper<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Autowired<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span>Service<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> UserMapper userMapper<span class="token punctuation">;</span>

    <span class="token keyword">public</span> User <span class="token function">queryById</span><span class="token punctuation">(</span>Long id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//selectByPrimaryKey  是Mapper内置的方法  可以通过id 来查询  一行信息</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>UserApplication</strong> 启动类</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>user<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>SpringApplication<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>SpringBootApplication<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>client<span class="token punctuation">.</span>discovery<span class="token punctuation">.</span>EnableDiscoveryClient<span class="token punctuation">;</span>
<span class="token keyword">import</span> tk<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>MapperScan<span class="token punctuation">;</span>

<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@MapperScan</span><span class="token punctuation">(</span><span class="token string">"com.itheima.user.mapper"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span> <span class="token comment" spellcheck="true">// 开启EurekaClient功能</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserApplication</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        SpringApplication<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>UserApplication<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以上都配置完了 开启 启动类 在游览器中 输入以下 url</p><p><a href="http://localhost:9091/user/2" target="_blank" rel="noopener">http://localhost:9091/user/2</a></p><p>我是使用的火狐</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da13.jpg" alt=""></p><p>这里注意 如果你控制台每隔几十秒出现:</p><blockquote><p>com.netflix.discovery.shared.transport.TransportException: Cannot execute request on any known server</p><p>xxxxxxxxxxxxxxx</p></blockquote><p>不要着急 这是 没有找到 eureka-server 服务 下面我们会创建的</p><h3 id="Eureka介绍"><a href="#Eureka介绍" class="headerlink" title="Eureka介绍"></a>Eureka介绍</h3><p>在搭建 eureka-server服务前我们 先来了解下 Eureka的机制</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da20.png" alt=""></p><p>就好比是中间商 卖房子的(服务) 到中间商登记 买房子到 中间商哪里去买 这样买房子的人就有很多选择了</p><p>而 eureka 还能有效防止 服务宕机的问题 需要集群</p><p>注册中心服务端主要对外提供了三个功能：</p><p><strong>服务注册</strong><br>服务提供者启动时，会通过 Eureka Client 向 Eureka Server 注册信息，Eureka Server 会存储该服务的信息，Eureka Server 内部有二层缓存机制来维护整个注册表</p><p><strong>提供注册表</strong><br>服务消费者在调用服务时，如果 Eureka Client 没有缓存注册表的话，会从 Eureka Server 获取最新的注册表</p><p><strong>Register: 服务注册</strong><br>服务的提供者，将自身注册到注册中心，服务提供者也是一个 Eureka Client。当 Eureka Client 向 Eureka Server 注册时，它提供自身的元数据，比如 IP 地址、端口，运行状况指示符 URL，主页等。</p><p>Eureka Client 会每隔 30 秒发送一次心跳来续约。 通过续约来告知 Eureka Server 该 Eureka Client 运行正常，没有出现问题。 默认情况下，如果 Eureka Server 在 90 秒内没有收到 Eureka Client 的续约，Server 端会将实例从其注册表中删除，此时间可配置，一般情况不建议更改。</p><p><strong>自我保护机制</strong></p><p>默认情况下，如果 Eureka Server 在一定的 90s 内没有接收到某个微服务实例的心跳，会注销该实例。但是在微服务架构下服务之间通常都是跨进程调用，网络通信往往会面临着各种问题，比如微服务状态正常，网络分区故障，导致此实例被注销。</p><p>固定时间内大量实例被注销，可能会严重威胁整个微服务架构的可用性。为了解决这个问题，Eureka 开发了自我保护机制，那么什么是自我保护机制呢？</p><p>Eureka Server 在运行期间会去统计心跳失败比例在 15 分钟之内是否低于 85%，如果低于 85%，Eureka Server 即会进入自我保护机制。</p><p><strong>Eureka Server 触发自我保护机制后，页面会出现提示：</strong></p><p>接下来我们搭建eureka-server 服务 用于将 服务注册</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da14.png" alt=""></p><p><strong>Eureka Server 进入自我保护机制，会出现以下几种情况：</strong><br>(1 Eureka 不再从注册列表中移除因为长时间没收到心跳而应该过期的服务<br>(2 Eureka 仍然能够接受新服务的注册和查询请求，但是不会被同步到其它节点上(即保证当前节点依然可用)<br>(3 当网络稳定时，当前实例新的注册信息会被同步到其它节点中</p><p>Eureka 自我保护机制是为了防止误杀服务而提供的一个机制。当个别客户端出现心跳失联时，则认为是客户端的问题，剔除掉客户端；当 Eureka 捕获到大量的心跳失败时，则认为可能是网络问题，进入自我保护机制；当客户端心跳恢复时，Eureka 会自动退出自我保护机制。 (推出保护机制后 刷新页面就没有报错了)</p><p>如果在保护期内刚好这个服务提供者非正常下线了，此时服务消费者就会拿到一个无效的服务实例，即会调用失败。对于这个问题需要服务消费者端要有一些容错机制，如重试，断路器等。</p><p><strong>通过在 Eureka Server 配置如下参数，开启或者关闭保护机制，生产环境建议打开：</strong></p><pre class="line-numbers language-java"><code class="language-java">eureka<span class="token punctuation">.</span>server<span class="token punctuation">.</span>enable<span class="token operator">-</span>self<span class="token operator">-</span>preservation<span class="token operator">=</span><span class="token boolean">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="eureka-server"><a href="#eureka-server" class="headerlink" title="eureka-server"></a>eureka-server</h3><p>我们开始搭建eureka-server服务</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da16.jpg" alt=""></p><p><strong>pom.xml</strong></p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-netflix-eureka-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>application.yml</strong></p><pre class="line-numbers language-yml"><code class="language-yml">#设置端口号
server:
  port: 10086 
# 设置服务名称  会在Eureka中显示
spring:
  application:
    name: eureka-server
#配置Eureka     
eureka:
  client:
    register-with-eureka: false # 是否注册自己到EurekaServer，默认是true
    fetch-registry: false # 是否拉取其它服务的信息，默认是true
    service-url: # EurekaServer的地址，现在是自己的地址，如果是集群，需要加上其它Server的地址。
      defaultZone: http://127.0.0.1:${server.port}/eureka<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>EurekaDemoApplication</strong></p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>enureka<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>SpringApplication<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>SpringBootApplication<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>eureka<span class="token punctuation">.</span>server<span class="token punctuation">.</span>EnableEurekaServer<span class="token punctuation">;</span>

<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableEurekaServer</span> <span class="token comment" spellcheck="true">// 声明这个应用是一个EurekaServer</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EurekaDemoApplication</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        SpringApplication<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>EurekaDemoApplication<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>打开user_service服务</p><p>然后打开当前 eureka-server 服务，</p><p>在游览器中 访问：<a href="http://127.0.0.1:10086" target="_blank" rel="noopener">http://127.0.0.1:10086</a> 最好在谷歌中打开 因为有中文翻译</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da17.jpg" alt=""></p><p>注意你可能 没有 出现注册的 服务 别着急 等一会 Eureka Client 会每隔 30 秒发送一次心跳来续约 然后在刷新页面</p><p>我们现在 已经将 user_service服务 注册到 了 eureka-server 中</p><p>我们可以 获取这些被注册 服务 的 ip 和 端口号 然后利用这些信息 拼接 成 http请求 然后</p><p>通过 http客户端工具 来 发送 请求 返回来 想要的数据</p><p>我们可以简称为: 消费者</p><h3 id="consumer-demo"><a href="#consumer-demo" class="headerlink" title="consumer-demo"></a>consumer-demo</h3><p>我们创建一个<strong>consumer-demo</strong> <strong>消费者</strong>项目</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da18.jpg" alt=""></p><p><strong>pom.xml</strong></p><pre class="line-numbers language-xml"><code class="language-xml">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token comment" spellcheck="true">&lt;!-- 添加OkHttp支持 --></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.squareup.okhttp3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>okhttp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.9.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

        <span class="token comment" spellcheck="true">&lt;!-- Eureka客户端 --></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>application.yml</strong></p><pre class="line-numbers language-yml"><code class="language-yml"># 配置端口号
server:
  port: 80
# 设置服务名称  会在Eureka中显示 而且其他方也要用的
spring:
  application:
    name: consumer-service
# 注册到 Eureka中  
eureka:
  client:
    service-url:
      defaultZone: http://127.0.0.1:10086/eureka<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>ConsumerController</strong></p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>controller<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>entity<span class="token punctuation">.</span>User<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Autowired<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>client<span class="token punctuation">.</span>ServiceInstance<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>client<span class="token punctuation">.</span>discovery<span class="token punctuation">.</span>DiscoveryClient<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>client<span class="token punctuation">.</span>RestTemplate<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/consumer"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsumerController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> RestTemplate restTemplate<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> DiscoveryClient discoveryClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/{id}"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> User <span class="token function">queryId</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token keyword">int</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 通过在application.yml中设置的name 获取在Eureka中注册的实例 </span>
         <span class="token comment" spellcheck="true">// 因为  user-service  可能不只一个 (防止宕机)   所以是集合 </span>
        List<span class="token operator">&lt;</span>ServiceInstance<span class="token operator">></span> instances <span class="token operator">=</span>  discoveryClient<span class="token punctuation">.</span><span class="token function">getInstances</span><span class="token punctuation">(</span><span class="token string">"user-service"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment" spellcheck="true">// 我们 只用第一个就行了  如果第一个宕机了那么 第2个自然就变成第一个了   </span>
        <span class="token comment" spellcheck="true">//如果不懂去看一下Eureka的心跳机制  上面有</span>
        ServiceInstance instance <span class="token operator">=</span>  instances<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// getHost获取ip     getPort() 获取端口号  然后拼接成 http请求 以及要请求的内容</span>
        String url <span class="token operator">=</span> <span class="token string">"http://"</span><span class="token operator">+</span>instance<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">":"</span><span class="token operator">+</span>instance<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"/user/"</span><span class="token operator">+</span>id<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 通过http请求客户端工具 将请求发送  获取请求 对应的数据</span>
        User user <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span>User<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> user<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>User</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>entity<span class="token punctuation">;</span>

<span class="token keyword">import</span> lombok<span class="token punctuation">.</span>Data<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>Serializable<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Date<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>

    <span class="token keyword">private</span> Long id<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 用户名</span>
    <span class="token keyword">private</span> String userName<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 密码</span>
    <span class="token keyword">private</span> String password<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 姓名</span>
    <span class="token keyword">private</span> String name<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 年龄</span>
    <span class="token keyword">private</span> Integer age<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 性别，1男性，2女性</span>
    <span class="token keyword">private</span> Integer sex<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 出生日期</span>
    <span class="token keyword">private</span> Date birthday<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 创建时间</span>
    <span class="token keyword">private</span> Date created<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 更新时间</span>
    <span class="token keyword">private</span> Date updated<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 备注</span>
    <span class="token keyword">private</span> String note<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 自己添加 get  set   和toString()</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ConsumerApplication (引导类)</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>consumer<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>SpringApplication<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>SpringBootApplication<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>client<span class="token punctuation">.</span>discovery<span class="token punctuation">.</span>EnableDiscoveryClient<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Bean<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span>client<span class="token punctuation">.</span>OkHttp3ClientHttpRequestFactory<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>client<span class="token punctuation">.</span>RestTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsumerApplication</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> RestTemplate <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 我们使用了OkHttp客户端,只需要注入工厂即可</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OkHttp3ClientHttpRequestFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        SpringApplication<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span> ConsumerApplication<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>开启务 eureka-server 服务 和 user_service服 然后在开启 consumer-demo服务</p><p>在游览器中输入</p><p><a href="http://localhost/consumer/2" target="_blank" rel="noopener">http://localhost/consumer/2</a></p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da19.jpg" alt=""></p><h2 id="Enreka集群"><a href="#Enreka集群" class="headerlink" title="Enreka集群"></a>Enreka集群</h2><p>都知道Enreka是中间商 用于 调和 消费者(卖家) 和 服务(卖家) 但是如果我 Enreka 宕机了那么 服务和消费者之间的 关联也就断了 导致整个网站都无法使用了 为了解决以上问题 我们开启多个Enreka 其中一个Enreka宕机了 那么 自动连接 正常的 Enreka</p><p>多个Eureka Server之间也会互相注册为服务，当服务提供者注册到Eureka Server集群中的某个节点时，该节点会把服务的信息同步给集群中的每个节点，从而实现<strong>数据同步</strong>。因此，无论客户端访问到Eureka Server集群中的任意一个节点，都可以获取到完整的服务列表信息。</p><p>原理很简单 我们在创建一个Module 名字 :eureka-server1将 上面 eureka-server 内的文件复制过去</p><p>最简单的方式就是 将eureka-server1 内的src删除 然后将eureka-server中的src 复制进入去</p><p>然后修改eureka-server1中的pom.xml 就可以了</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da22.jpg" alt=""></p><p>注意我们将application.yml 配置文件内eureka下面内容删除了 因为默认是true 所以不用添加</p><blockquote><p>register-with-eureka<br>fetch-registry</p></blockquote><p>修改配置文件 eureka-server 的 application.yml</p><pre class="line-numbers language-yml"><code class="language-yml">server:
  port: 10086 # 端口
  # 设置服务名称  会在Eureka中显示 而且其他方也要用的
spring:
  application:
    name: eureka-server
# 在eureka中注册
eureka:
  client:
    service-url: # EurekaServer的地址，现在是自己的地址，如果是集群，需要加上其它Server的地址。
      defaultZone: http://127.0.0.1:10087/eureka<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>修改配置文件 eureka-server1 的 application.yml</p><pre class="line-numbers language-yml"><code class="language-yml">server:
  port: 10087  # 端口
  # 设置服务名称  会在Eureka中显示 而且其他方也要用的
spring:
  application:
    name: eureka-server 
# 在eureka中注册
eureka:
  client:
    service-url: # EurekaServer的地址，现在是自己的地址，如果是集群，需要加上其它Server的地址。
      defaultZone: http://127.0.0.1:10086/eureka<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过这两个配置 的端口号 就可以发现 eureka 他们是相互注册的 也就是数据会共享 当其中一个宕机了 其他的还能正常工作 就和下面这图片一个原理</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da21.jpg" alt=""></p><p>然后将其他 客户端的 注册 改一下</p><p>比如我们上面的案例: user_service 和 consumer-demo</p><p>之前是只有一个 eureka 的时候 只需注册 一个eureka</p><p>现在有两个eureka那么我们需要注册 两个 eureka</p><p>修改user_service 和 consumer-demo 的 application.yml 配置文件内容</p><p>使用逗号 分割</p><pre class="line-numbers language-yml"><code class="language-yml">eureka:
  client:
    service-url:
      defaultZone: http://127.0.0.1:10086/eureka,http://127.0.0.1:10087/eureka<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>然后我们将 eureka-server eureka-server1 和 user_service 和 consumer-demo消费者 都启动</p><p>然后到Eureka页面里看看 什么情况</p><p>在游览器中输入 : <a href="http://127.0.0.1:10087" target="_blank" rel="noopener">http://127.0.0.1:10087</a></p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da23.jpg" alt=""></p><p>在游览器中输入 : <a href="http://127.0.0.1:10086" target="_blank" rel="noopener">http://127.0.0.1:10086</a></p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da24.jpg" alt=""></p><p>可以发现 这2个 eureka 数据都相同 也就是 完成了 数据同步</p><p>然后我们访问 <a href="http://localhost/consumer/2" target="_blank" rel="noopener">http://localhost/consumer/2</a></p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da19.jpg" alt=""></p><p>发现没问题</p><p>那么我们模拟其中一个eureka服务器宕机了 随意将一个 eureka服务关闭了</p><p>重启 consumer-demo</p><p>然后我们在访问 <a href="http://localhost/consumer/2" target="_blank" rel="noopener">http://localhost/consumer/2</a></p><p>可以发现还是能访问的</p><p>那么我们将 最后一个 eureka服务关闭了 然后重启consumer-demo消费者</p><p>然后我们在访问 <a href="http://localhost/consumer/2" target="_blank" rel="noopener">http://localhost/consumer/2</a> 看看还能访问吗?</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da25.jpg" alt=""></p><p>经过我们的测试 只要有一个 eureka服务 存活 那么 都是能正常工作的</p><p>如果还不太懂 那么我拿现实举例:</p><p>我将一个 eureka服务 放在北京服务器里 然后将另一个eureka服务放在上海服务器里</p><p>北京的 eureka服务 宕机了 那么我上海的还能 正常工作 不会影响 页面的 微服务支持</p><p>注意在关闭 其他 eureka服务的时候 其他客户端中可能会报一些错误</p><blockquote><p>Caused by: java.net.ConnectException: Connection refused: connect</p><p>xxxxx…….</p></blockquote><p>这是正常的 因为注册的时候我在两个 eureka服务中注册了 我每次发心跳的时候</p><p>就需要向这两个eureka服务发送心跳 证明我还存活 但是如果其中一个出现问题了 那么就会出现 <strong>连接被拒绝</strong></p><p>这不影响 程序 正常运行</p><p>如果有三个Eureka ,则每一个EurekaServer都需要注册到其它几个Eureka服务中，</p><p>例如：有三个分别为10086、10087、10088，</p><p>则：</p><p>10086要注册到10087和10088上</p><pre class="line-numbers language-yml"><code class="language-yml">defaultZone: http://127.0.0.1:10087/eureka,http://127.0.0.1:10088/eureka<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>10087要注册到10086和10088上</p><pre class="line-numbers language-yml"><code class="language-yml">defaultZone: http://127.0.0.1:10086/eureka,http://127.0.0.1:10088/eureka<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>10088要注册到10086和10087上</p><pre class="line-numbers language-yml"><code class="language-yml">defaultZone: http://127.0.0.1:10086/eureka,http://127.0.0.1:10087/eureka<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>然后其他客服端</p><pre class="line-numbers language-yml"><code class="language-yml">eureka:
  client:
    service-url:
      defaultZone: http://127.0.0.1:10086/eureka,http://127.0.0.1:10087/eureka,http://127.0.0.1:10088/eureka<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>演示:</p><p>我们创建一个Module 名称: eureka-server2 将 eureka-server1内容复制过去</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da27.jpg" alt=""></p><p>然后安装上面要求修改application.yml 配置文件内容</p><p>eureka-server 的application.yml</p><pre class="line-numbers language-yml"><code class="language-yml">server:
  port: 10086 # 端口
  # 设置服务名称  会在Eureka中显示 而且其他方也要用的
spring:
  application:
    name: eureka-server 
# 在eureka中注册
eureka:
  client:
    service-url: # EurekaServer的地址，现在是自己的地址，如果是集群，需要加上其它Server的地址。
      defaultZone: http://127.0.0.1:10087/eureka,http://127.0.0.1:10088/eureka<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>eureka-server1 的application.yml</p><pre class="line-numbers language-yml"><code class="language-yml">server:
  port: 10087  # 端口
  # 设置服务名称  会在Eureka中显示 而且其他方也要用的
spring:
  application:
    name: eureka-server 
# 在eureka中注册
eureka:
  client:
    service-url: # EurekaServer的地址，现在是自己的地址，如果是集群，需要加上其它Server的地址。
      defaultZone: http://127.0.0.1:10086/eureka,http://127.0.0.1:10088/eureka<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>eureka-server2 的application.yml</p><pre class="line-numbers language-yml"><code class="language-yml">server:
  port: 10088 # 端口
  # 设置服务名称  会在Eureka中显示 而且其他方也要用的
spring:
  application:
    name: eureka-server 
# 在eureka中注册
eureka:
  client:
    service-url: # EurekaServer的地址，现在是自己的地址，如果是集群，需要加上其它Server的地址。
      defaultZone: http://127.0.0.1:10086/eureka,http://127.0.0.1:10087/eureka<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后修改 user_service 和 consumer-demo 客户端的 application.yml</p><pre class="line-numbers language-yml"><code class="language-yml">#注册Eureka
eureka:
  client:
    service-url:
      defaultZone: http://127.0.0.1:10086/eureka,http://127.0.0.1:10087/eureka,http://127.0.0.1:10088/eureka<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以上都 弄完了 那么我们 来试试</p><p>将所有的 服务 启动 eureka-server eureka-server1 eureka-server2 user_service consumer-demo</p><p>我们先进入到各个 的 eureka的页面中 看看</p><p><a href="http://127.0.0.1:10086" target="_blank" rel="noopener">http://127.0.0.1:10086</a></p><p><a href="http://127.0.0.1:10087" target="_blank" rel="noopener">http://127.0.0.1:10087</a></p><p><a href="http://127.0.0.1:10088" target="_blank" rel="noopener">http://127.0.0.1:10088</a></p><p>可以看到 有三个 eureka 注册成功了 也就代表 这三个 eureka 数据已经共享了</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da26.jpg" alt=""></p><p>我们随意关闭两个 eureka服务 然后重启 consumer-demo</p><p>然后我们在访问 <a href="http://localhost/consumer/2" target="_blank" rel="noopener">http://localhost/consumer/2</a></p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da19.jpg" alt=""></p><p>访问成功 代表我们的 3个eureka 集成服务器 搭建成功 至于4个 5个 ….. 以此类推</p><p>一般情况下 2 个就够了 你北京的宕机了 难道上海的也宕机了 那么 你运气也太背了 可以去买彩票了</p><p>在日常我们 写代码的时候 不可能搭建这么多 的 eureka 服务</p><p>只有当项目上线后 我们将一份 eureka 服务代码 复制多份 修改下配置文件 放在不同服务器中</p><h2 id="搭建测试eureka-集成"><a href="#搭建测试eureka-集成" class="headerlink" title="搭建测试eureka 集成"></a>搭建测试eureka 集成</h2><p>为了方便测试 但是我们也不想创建这么多eureka-server 来回修改 那么我们可以采用下面的方式</p><p>如果你看完 上面的 所有的 内容 那么现在 你IDEA中 应该有 eureka-server eureka-server1 eureka-server2</p><p>这三个 eureka服务 <strong>如果你没看上面的内容 那么 不好意思 下面的内容 你可能看不懂</strong></p><p>我们将 eureka-server1 eureka-server2都删除</p><p>然后就剩下</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da28.jpg" alt=""></p><p>然后修改eureka-server的application.yml配置</p><pre class="line-numbers language-yml"><code class="language-yml">server:
  port: ${port:10086} # 端口
  # 设置服务名称  会在Eureka中显示 而且其他方也要用的
spring:
  application:
    name: eureka-server 
# 在eureka中注册
eureka:
  client:
    service-url: # EurekaServer的地址，现在是自己的地址，如果是集群，需要加上其它Server的地址。
      defaultZone: ${defaultZone:http://127.0.0.1:10086/eureka}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>${xxx} 作用是 获取 JVM options 的配置 如果JVM没有配置那么会使用默认参数 就是我们上面设置的</p><p>我们可以在IDEA中配置JVM options 下面会有 等等</p><p>我们将其他的客户端 都修改过来</p><p>比如我们就注册2个 eureka 服务 10086 和 10087</p><p>那么修改 user_service 和 consumer-demo的 application.yml配置</p><pre class="line-numbers language-yml"><code class="language-yml">eureka:
  client:
    service-url:
      defaultZone: http://127.0.0.1:10086/eureka,http://127.0.0.1:10087/eureka<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><strong>我们先了解下参数</strong></p><p>注册两个 eureka 启动器 10086 10087</p><blockquote><p>10086<br>-Dport=10086 -DdefaultZone=<a href="http://127.0.0.1:10087/eureka" target="_blank" rel="noopener">http://127.0.0.1:10087/eureka</a></p><p>10087<br>-Dport=10087 -DdefaultZone=<a href="http://127.0.0.1:10086/eureka" target="_blank" rel="noopener">http://127.0.0.1:10086/eureka</a></p></blockquote><p>注册三个 eureka 启动器 10086 10087 10088</p><blockquote><p>10086<br>-Dport=10086 -DdefaultZone=<a href="http://127.0.0.1:10087/eureka,http://127.0.0.1:10088/eureka" target="_blank" rel="noopener">http://127.0.0.1:10087/eureka,http://127.0.0.1:10088/eureka</a></p><p>10087<br>-Dport=10087 -DdefaultZone=<a href="http://127.0.0.1:10086/eureka,http://127.0.0.1:10088/eureka" target="_blank" rel="noopener">http://127.0.0.1:10086/eureka,http://127.0.0.1:10088/eureka</a></p><p>10088<br>-Dport=10086 -DdefaultZone=<a href="http://127.0.0.1:10086/eureka,http://127.0.0.1:10087/eureka" target="_blank" rel="noopener">http://127.0.0.1:10086/eureka,http://127.0.0.1:10087/eureka</a></p></blockquote><p>注册4 5 6 …..以此类推</p><p>知道了怎么配置了 那么我们开始配置IDEA</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da29.jpg" alt=""></p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da30.jpg" alt=""></p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da31.jpg" alt=""></p><p>然后依次将下面的所有服务打开 看到旁边的绿色三角了吗 没错就是这里</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da32.jpg" alt=""></p><p>然后</p><p><a href="http://127.0.0.1:10086" target="_blank" rel="noopener">http://127.0.0.1:10086</a></p><p><a href="http://127.0.0.1:10087" target="_blank" rel="noopener">http://127.0.0.1:10087</a></p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud//img/da33.jpg" alt=""></p><p>我们来访问下试试</p><p><a href="http://localhost/consumer/2" target="_blank" rel="noopener">http://localhost/consumer/2</a></p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da19.jpg" alt=""></p><p>发现没问题</p><p>那么我们关闭一个 eureka服务器 然后重启consumer-demo</p><p>在<a href="http://localhost/consumer/2试试" target="_blank" rel="noopener">http://localhost/consumer/2试试</a></p><p>发现也是能访问的</p><h2 id="其他参数设置"><a href="#其他参数设置" class="headerlink" title="其他参数设置"></a>其他参数设置</h2><p>根据情况自行设置 也可以使用默认 eureka-server是服务端 其他都是客服端</p><p>默认注册时使用的是主机名或者localhost，如果想用ip进行注册，可以在 user-service ….也就是客户端中添加配置如下：</p><pre class="line-numbers language-yml"><code class="language-yml">#注册Eureka
eureka:
  client:
    service-url:
      defaultZone: http://127.0.0.1:10086/eureka,http://127.0.0.1:10087/eureka
  instance:
    ip-address: 127.0.0.1 # ip地址
    prefer-ip-address: true # 更倾向于使用ip，而不是host名<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>服务续约</strong></p><p>在注册服务完成以后，服务提供者会维持一个心跳（定时向EurekaServer发起Rest请求），告诉EurekaServer：“我还活着”。这个我们称为服务的续约（renew）；</p><p>有两个重要参数可以修改服务续约的行为；可以在 user-service…..也就是客户端 中添加如下配置项：</p><pre class="line-numbers language-yml"><code class="language-yml">#注册Eureka
eureka:
  client:
    service-url:
      defaultZone: http://127.0.0.1:10086/eureka,http://127.0.0.1:10087/eureka
  instance:
    lease-expiration-duration-in-seconds: 90 
    lease-renewal-interval-in-seconds: 30<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>lease-renewal-interval-in-seconds：服务续约(renew)的间隔，默认为30秒</p><p>lease-expiration-duration-in-seconds：服务失效时间，默认值90秒</p><p>也就是说，默认情况下每隔30秒服务会向注册中心发送一次心跳，证明自己还活着。如果超过90秒没有发送心跳，</p><p>EurekaServer就会认为该服务宕机，会定时（eureka.server.eviction-interval-timer-in-ms设定的时间）从服务列表中移除，这两个值在生产环境不要修改，默认即可。</p><p><strong>获取服务列表</strong></p><p>当服务消费者启动时，会检测 eureka.client.fetch-registry=true (默认) ，则会从EurekaServer服务的列表拉取只读备份，然后缓存在本地。并且 每隔30秒 会重新拉取并更新数据。可以在 consumer-demo项目中通过下面的参数来修改</p><pre class="line-numbers language-yml"><code class="language-yml">eureka:
  client:
    service-url:
      defaultZone: http://127.0.0.1:10086/eureka,http://127.0.0.1:10087/eureka
    registry-fetch-interval-seconds: 10<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>如下的配置都是在Eureka Server服务端进行：</strong></p><p><strong>服务下线</strong></p><p>当服务进行正常关闭操作时，它会触发一个服务下线的REST请求给Eureka Server，告诉服务注册中心：“我要下线了”。服务中心接受到请求之后，将该服务置为下线状态。</p><p>这个过程死自动的无须配置</p><p><strong>失效剔除</strong></p><p>有时我们的服务可能由于内存溢出或网络故障等原因使得服务不能正常的工作，而服务注册中心并未收到“服务下</p><p>线”的请求。相对于服务提供者的“服务续约”操作，服务注册中心在启动时会创建一个定时任务，默认每隔一段时间（默认为60秒）将当前清单中超时（默认为90秒）没有续约的服务剔除，这个操作被称为失效剔除。</p><p>我们可以手动配置 剔除时间</p><pre class="line-numbers language-yml"><code class="language-yml"># 在eureka中注册
eureka:
  client:
    service-url: # EurekaServer的地址，现在是自己的地址，如果是集群，需要加上其它Server的地址。
      defaultZone: ${defaultZone:http://127.0.0.1:10086/eureka}
  server:
    eviction-interval-timer-in-ms:  3   #服务关闭3秒后剔除<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>设置后你就能看到控制台不断在刷新<code>Running the evict task with compensationTime xxms</code></p><p><strong>自我保护</strong></p><p>我们关停一个服务，很可能会在Eureka面板看到一条警告：</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da14.png" alt=""></p><p>​</p><p>这是触发了Eureka的自我保护机制。当服务未按时进行心跳续约时，Eureka会统计服务实例最近15分钟心跳续约的比例是否低于了85%。在生产环境下，因为网络延迟等原因，心跳失败实例的比例很有可能超标，但是此时就把服务剔除列表并不妥当，因为服务可能没有宕机。Eureka在这段时间内不会剔除任何服务实例，直到网络恢复正常。生产环境下这很有效，保证了大多数服务依然可用，不过也有可能获取到失败的服务实例，因此服务调用者必须做好服务的失败容错。</p><p>可以通过下面的配置来关停自我保护：</p><pre class="line-numbers language-yml"><code class="language-yml"># 在eureka中注册
eureka:
  client:
    service-url: # EurekaServer的地址，现在是自己的地址，如果是集群，需要加上其它Server的地址。
      defaultZone: ${defaultZone:http://127.0.0.1:10086/eureka}
  server:
    enable-self-preservation: false # 关闭自我保护模式（缺省为打开）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>关闭后管理页面会出现</p><blockquote><p><strong>THE SELF PRESERVATION MODE IS TURNED OFF. THIS MAY NOT PROTECT INSTANCE EXPIRY IN CASE OF NETWORK/OTHER PROBLEMS.</strong></p></blockquote><p>意思是: 自保存模式被关闭。这可能不能保护实例在网络/其他问题的情况下过期。</p><p>一般情况下 开发阶段可以关掉 生产环境就别关了</p><h2 id="负载均衡Ribbon"><a href="#负载均衡Ribbon" class="headerlink" title="负载均衡Ribbon"></a>负载均衡Ribbon</h2><p>什么事负载均衡 :</p><p>我简单比喻一下 : 就比如上面案例中的user_service 这个服务 如果1000个人同事访问这一个服务的话 是不是很慢 但是在一般情况下 往往会开启很多个 user-service 的集群。此时获取的服务列表中就会有多个，到底该访问哪一个呢</p><p>一般这种情况下就需要编写负载均衡算法，在多个实例列表中进行选择</p><p>有两种算法</p><ol><li><p>轮询算法(常用)</p><p>轮询算法 :就是依据多个服务器的端口号 从小到大 或者从大到小 依次执行 等所有这个服务器都执行一遍然后在从头开始</p><p>比如我集群了 10个user_service服务器 端口号 为: 9080~9090 现在有100个人访问</p><p>那么 第一个人访问 第一个user_service:9080 第二个人访问user_service:9081 等等以此类推一直到user_service:9090 然后在从头开始 这就是轮询算法</p><p><strong>轮询算法是默认算法 所以 无须修改</strong></p></li><li><p>随机算法</p><p>随机算法就和随机数一样 比如我开启了10个 user_service服务器 端口号 为: 9080~9090</p><p>那么每次访问的用户是 随机从这10个 user_service服务器 之间访问</p><p>在consumer-demo的配置文件中添加如下，就变成随机的了：</p></li></ol><pre class="line-numbers language-yml"><code class="language-yml"># 配置端口号
server:
  port: 80
# 设置服务名称  会在Eureka中显示 而且其他方也要用的
spring:
  application:
    name: consumer-service
eureka:
  client:
    service-url:
      defaultZone: http://127.0.0.1:10086/eureka,http://127.0.0.1:10087/eureka

user-service:
  ribbon:
    NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RandomRule<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>user-service 是你要访问的服务器的名称 其他都是固定的 (你可以配置多个 不同功能的服务器 比如xxx-service)</p><p><strong>因为Eureka中已经集成了Ribbon，所以我们无需引入新的依赖 但是我们需要手动开启。</strong></p><p>直接在consumer-demo服务 (消费者) 也可以说是发送请求的地方</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da34.png" alt=""></p><p>修改启动类里的 RestTemplate 这个方法上 添加 负载均衡开启注解 @LoadBalanced</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>consumer<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>SpringApplication<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>SpringBootApplication<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>client<span class="token punctuation">.</span>discovery<span class="token punctuation">.</span>EnableDiscoveryClient<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>client<span class="token punctuation">.</span>loadbalancer<span class="token punctuation">.</span>LoadBalanced<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Bean<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span>client<span class="token punctuation">.</span>OkHttp3ClientHttpRequestFactory<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>client<span class="token punctuation">.</span>RestTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsumerApplication</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@LoadBalanced</span>
    <span class="token keyword">public</span> RestTemplate <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 这次我们使用了OkHttp客户端,只需要注入工厂即可</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OkHttp3ClientHttpRequestFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        SpringApplication<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span> ConsumerApplication<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后我们复制一份user_service服务 将src 修改配置文件内的端口号就行 其他都不要动</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da37.jpg" alt=""></p><p>记得pom.xml内的需要的依赖 也复制过去</p><p>修改user_service1的application.yml配置文件内的端口号</p><pre class="line-numbers language-yml"><code class="language-yml"># 设置端口号
server:
  port:  9090<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>此刻我们就有两个 user_service 服务了 9091 和9090</p><p>把user_service 和user_service1 的IDEA启动名称改下 这样好区分</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da38.jpg" alt=""></p><p>如果只是测试的话 无须在项目里创建多个user_service 我们可以这样</p><p>修改 user_service内 application.yml配置文件下的端口号配置</p><pre class="line-numbers language-yml"><code class="language-yml"># 设置端口号
server:
  port:  ${port:9091}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>${} 的作用 就是 会获取JVM中配置的端口号 如果没有配置那么就使用默认的 9091 我在上面已经说过了这里就稍微提下</p><p>然后修改IDEA启动器配置 <code>-Dport=9091</code></p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da35.jpg" alt=""></p><p>我们在复制一份这个启动器 然后将 名称改为9090 以及把 VM options 这个参数改为<code>-Dport=9090</code></p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da36.jpg" alt=""></p><p>然后在consumer-demo服务Controller层中我们把请求 方式改一下 无须在获取 ip 和端口号了 而是 通过服务器的名称 来 获取</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>controller<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>entity<span class="token punctuation">.</span>User<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Autowired<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>client<span class="token punctuation">.</span>discovery<span class="token punctuation">.</span>DiscoveryClient<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>client<span class="token punctuation">.</span>RestTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"consumer"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsumerController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> RestTemplate restTemplate<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> DiscoveryClient discoveryClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/{id}"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> String <span class="token function">queryById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> Long id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String url <span class="token operator">=</span> <span class="token string">"http://user-service/user/"</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 返回JSON 格式的字符串</span>
        <span class="token keyword">return</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span>String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>你可以先 和 原来的代码 比一下 就能看出差别</p><p>然后我们把 所有的服务都打开</p><p>进入<a href="http://localhost:10086/" target="_blank" rel="noopener">http://localhost:10086/</a></p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da39.jpg" alt=""></p><p>如果出现了 2个user_service服务那么 就成功了 然后我们 来测试下看看 负载均衡 - 轮询 有没有开启</p><p>访问 <a href="http://localhost/consumer/2" target="_blank" rel="noopener">http://localhost/consumer/2</a></p><p>看看 user_service 服务器的控制台 有没有调用toString 打印类 的信息</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da40.jpg" alt=""></p><p>此时另一个 user_service 控制台没有 toString 打印类 的信息</p><p>然后我们在访问一下 <a href="http://localhost/consumer/2" target="_blank" rel="noopener">http://localhost/consumer/2</a> 看看 另一个 user_service 控制台出现了没</p><p>然后以此类推</p><p>然后我们可以发现 一个问题 我们将其中一个 user_service 停止了 那么访问的时候 就会出现</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da41.jpg" alt=""></p><p>如果没有出现 你多访问几次</p><p>这是什么问题呢? 我明明还有一个user_service 服务打开着呢</p><p>Eureka的服务治理强调了CAP原则中的AP，即可用性和可靠性。它与Zookeeper这一类强调CP（一致性，可靠性）的服务治理框架最大的区别在于：Eureka为了实现更高的服务可用性，牺牲了一定的一致性，极端情况下它宁愿接收故障实例也不愿丢掉健康实例，正如我们上面所说的自我保护机制。</p><p>但是，此时如果我们调用了这些不正常的服务，调用就会失败，从而导致其它服务不能正常工作！这显然不是我们愿意看到的。</p><p><strong>解决办法:使用Ribbon重试</strong></p><p>只需要简单配置即可实现Ribbon的重试：</p><p>修改 consumer-demo 服务的配置文件</p><pre class="line-numbers language-yml"><code class="language-yml"># 配置端口号
server:
  port: 80
# 设置服务名称  会在Eureka中显示 而且其他方也要用的
spring:
  application:
    name: consumer-service
  cloud:
    loadbalancer:
      retry:
        enabled: true # 开启Spring Cloud的重试功能
eureka:
  client:
    service-url:
      defaultZone: http://127.0.0.1:10086/eureka,http://127.0.0.1:10087/eureka
  ribbon:
    ConnectTimeout: 250 # Ribbon的连接超时时间
    ReadTimeout: 1000 # Ribbon的数据读取超时时间
    OkToRetryOnAllOperations: true # 是否对所有操作都进行重试
    MaxAutoRetriesNextServer: 1 # 切换实例的重试次数
    MaxAutoRetries: 1 # 对当前实例的重试次数<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后在consumer-demo的pom.xml 添加以下依赖</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.retry<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-retry<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>之后你 可以从新打开所有的服务器 然后 在试试关闭其中一个 user_service 服务 然后在次访问 发现就可以访问到了 但是 会出现一个新的问题 访问的效率有点低 这是没办法的事情</p><p>因为 如果某一个服务宕机了那么就会触发 ribbon 我需要先对当前的服务进行重试1次 如果重试之后还是请求不成功那么 我将切换到下一个服务再次尝试 这个过程的时间 大概2~5秒 如果切换2次服务还不成功那么就会出现失败的页面 切换服务的次数在上面可以设置 一般根据你有多少服务就设置多大</p><p>在案例中我们就2user_service 服务 那么我们就设置1就行了 其他的就都不要动 默认配置就行</p><p><strong>一般情况下是不推荐单独使用的 太影响效率了 和用户体验了 一般 配合 熔断器 就比较理想</strong></p><h2 id="熔断器Hystrix"><a href="#熔断器Hystrix" class="headerlink" title="熔断器Hystrix"></a>熔断器Hystrix</h2><p>那么Hystrix的作用是什么呢？具体要保护什么呢？</p><p>Hystrix是Netflflix开源的一个<strong>延迟和容错库，用于隔离访问远程服务、第三方库，防止出现级联失败</strong>。</p><p>在大型的分布式系统中，通常需要调用或操作远程的服务或者资源，这些远程的服务或者资源由于调用者不可以控的原因比如网络连接缓慢，资源被占用或者暂时不可用等原因，导致对这些远程资源的调用失败。这些错误通常在稍后的一段时间内可以恢复正常。</p><p>比如:</p><p>用户的一次请求 然后SpringCloud 向多个不同功能的服务器发送请求 然后将请求的结果 经过处理后返回给请求的用户</p><p>如果 一次业务请求，需要调用A、P、H、I四个服务，这四个服务又可能调用其它服务。如果此时，某个服务出现异常：</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da42.jpg" alt=""></p><p>例如： 服务器 I 发生异常，那么用户请求会阻塞一段时间 不断的进行重试连接 持续一段时间大概也就2~5秒 ，则tomcat的这个线程不会释放 ，在这个段时间内 越来越多的用户请求到来 ， 则越来越多的线程会阻塞：</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da43.jpg" alt=""></p><p>服务器支持的线程和并发数有限，请求一直阻塞，会导致服务器资源耗尽，从而导致所有其它服务都不可用，形成雪崩效应。</p><p>这就好比，一个汽车生产线，生产不同的汽车，需要使用不同的零件，如果某个零件因为种种原因无法使用，那么就会造成整台车无法装配，陷入等待零件的状态，直到零件到位，才能继续组装。 此时如果有很多个车型都需要这个零件，那么整个工厂都将陷入等待的状态，导致所有生产都陷入瘫痪。一个零件的波及范围不断扩大。</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da44.jpg" alt=""></p><p>Hystrix解决雪崩问题的手段主要是服务降级</p><p><strong>线程隔离</strong></p><p>Hystrix为每个依赖服务调用分配一个小的线程池，如果线程池已满调用将被立即拒绝，默认不采用排队，<strong>加速</strong></p><p><strong>失败判定时间</strong>。</p><p>弊端就是 如果人多的时候 那么小的线程池就会爆满 其他用户就访问不进入</p><p>可以设置<code>maxQueueSize 和 queueSizeRejectionThreshold</code> 来开启线程队列和队列数量</p><p>具体设置在服务熔断最后面有这里就不说了</p><p>如果<strong>线程池已满</strong>，或者<strong>请求超时</strong>，则会进行降级处理，什么是服务降级？</p><p>用户的请求故障时，不会被阻塞，更不会无休止的等待或者看到系统崩溃，而是返回一个执行结果（例如返回友好的提示信息） 。</p><p><strong>服务降级虽然会导致请求失败，但是不会导致阻塞，而且对其它服务没有响应。</strong></p><p>触发Hystrix服务降级的情况：</p><p>线程池已满</p><p>请求超时</p><h3 id="服务降级"><a href="#服务降级" class="headerlink" title="服务降级"></a>服务降级</h3><p>在上面案例的基础上 我们来实现降级</p><p>在 consumer-demo 消费端系统的pom.xml文件添加如下依赖：</p><pre class="line-numbers language-xml"><code class="language-xml">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.retry<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-retry<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>在consumer-demo服务的 启动类 ConsumerApplication 上添加注解：@EnableCircuitBreaker</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da46.jpg" alt=""></p><p>可以看到，我们类上的注解越来越多，在微服务中，经常会引入上面的三个注解，</p><p>于是Spring就提供了一个组合注解：@SpringCloudApplication 这个注解里面包含了上面三个注解 你可以进去看看</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@SpringCloudApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsumerApplication</span> <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//............</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>当目标服务的调用出现故障或者访问超时，<strong>我们希望快速失败</strong>，给用户一个友好提示。因此需要提前编写好失败时的降级处理逻辑，要使用@HystrixCommand来完成。</p><p><strong>注意: 需要降级的方法 和 降级的方法 必须返回值和参数保持一致 否则就会出现报错找不到404</strong></p><p>还有就是不要玩小聪明 使用转发和重定向在降级方法里去请求一个静态页面 没什么必要还影响原方法</p><p>建议就是 自己写一个html 将代码复制到String str=”内容” 在IDEA中会自动给你排版拼接</p><p>然后你直接return str ; 然后就可以在网页中看到效果了 然后保存好 以后都用它了</p><p>这里提示下 如果你写的 带图片等静态资源 那么可以放在resources下的 static目录下 需要自己创建</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da49.jpg" alt=""></p><p>这个目录是SpringBoot 默认的静态访问目录 直接 /index.html 就行了</p><p><strong>编写降级逻辑</strong></p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>controller<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>hystrix<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>javanica<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>HystrixCommand<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Autowired<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>client<span class="token punctuation">.</span>discovery<span class="token punctuation">.</span>DiscoveryClient<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>client<span class="token punctuation">.</span>RestTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"consumer"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsumerController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> RestTemplate restTemplate<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> DiscoveryClient discoveryClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/{id}"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token annotation punctuation">@HystrixCommand</span><span class="token punctuation">(</span>fallbackMethod <span class="token operator">=</span> <span class="token string">"queryByIdFallback"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String  <span class="token function">queryById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> Long id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String url <span class="token operator">=</span> <span class="token string">"http://user-service/user/"</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>

        <span class="token keyword">return</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//访问失败后执行的方法</span>
    <span class="token keyword">public</span> String <span class="token function">queryByIdFallback</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span>Long id <span class="token punctuation">)</span>  <span class="token punctuation">{</span>
       String str<span class="token operator">=</span><span class="token string">"&lt;h1>对不起，网络太拥挤了！&lt;h1>"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> str<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>注意:Hystrix 一般情况下 都是使用 String 作为返回值</p><p>因为失败逻辑中返回User对象没有太大意义，一般会返回友好提示。所以把queryById的方法改造为返回String，反正也是Json数据。这样会比较方便。 访问的方法和访问失败后的方法 返回值能保持一致</p></blockquote><p>说明：</p><p>@HystrixCommand(fallbackMethod = “queryByIdFallBack”)：</p><p>用来声明一个降级逻辑的方法 也可以理解 访问失败后的方法</p><p>然后我们还是一样将 所有服务器启动 然后关掉其中一个user-service</p><p>之后 访问<a href="http://localhost/consumer/2" target="_blank" rel="noopener">http://localhost/consumer/2</a></p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da47.jpg" alt=""></p><p>你在刷新几下一下</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da48.jpg" alt=""></p><p>这样就有效解决了 负载均衡中的 Ribbon的重试 导致长时间 页面处于 空白状态 或者其他资源访问失败等问题</p><p><strong>全局设置@HystrixCommand</strong></p><p>@HystrixCommand(“降级方法”)写在了某个业务方法上，如果这样的方法很多，那岂不是要写很多。</p><p>所以可以把配置加在类上，实现全局所有方法都共享使用降级方法</p><p>在类上 添加</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@DefaultProperties</span><span class="token punctuation">(</span>defaultFallback <span class="token operator">=</span> <span class="token string">"payment_Global_FallbackMethod"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da51.jpg" alt=""></p><p>创建payment_Global_FallbackMethod方法</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> String <span class="token function">payment_Global_FallbackMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
        String str<span class="token operator">=</span><span class="token string">"&lt;div style=\"width: 100%;text-align: center\">\n"</span> <span class="token operator">+</span>
                <span class="token string">"    &lt;h1 >对不起，网络太拥挤了！ 刷新重试&lt;/h1>\n"</span> <span class="token operator">+</span>
                <span class="token string">"&lt;/div>"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> str<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后在需要的方法上添加 @HystrixCommand</p><p><strong>注意事项:</strong> <strong>该类中</strong>所有方法的<strong>返回类型</strong>要与payment_Global_FallbackMethod的方法<strong>的返回类型一致</strong></p><p>而且 payment_Global_FallbackMethod方法<strong>不能有参数</strong> <strong>不能在内部实现 转发和重定向 所以你懂得</strong></p><p><strong>只能自己拼接html 和css</strong></p><p><strong>完整版</strong></p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>controller<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>hystrix<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>javanica<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>DefaultProperties<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>hystrix<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>javanica<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>HystrixCommand<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Autowired<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>client<span class="token punctuation">.</span>discovery<span class="token punctuation">.</span>DiscoveryClient<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>client<span class="token punctuation">.</span>RestTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"consumer"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@DefaultProperties</span><span class="token punctuation">(</span>defaultFallback <span class="token operator">=</span> <span class="token string">"payment_Global_FallbackMethod"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsumerController</span> <span class="token punctuation">{</span>


    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> RestTemplate restTemplate<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> DiscoveryClient discoveryClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/{id}"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token annotation punctuation">@HystrixCommand</span>   <span class="token comment" spellcheck="true">//不要忘记添加</span>
    <span class="token keyword">public</span> String <span class="token function">queryById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> Long id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String url <span class="token operator">=</span> <span class="token string">"http://user-service/user/"</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token keyword">return</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//所有添加@HystrixCommand访问失败后 执行的方法</span>
    <span class="token keyword">public</span> String <span class="token function">payment_Global_FallbackMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
        String str<span class="token operator">=</span><span class="token string">"&lt;div style=\"width: 100%;text-align: center\">\n"</span> <span class="token operator">+</span>
                <span class="token string">"    &lt;h1 >对不起，网络太拥挤了！ 刷新重试&lt;/h1>\n"</span> <span class="token operator">+</span>
                <span class="token string">"&lt;/div>"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> str<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>在次提醒 不要在降级的方法中使用 转发和从定向 至于为什么 这里就不说了</strong> 建议自己美化好一个静态html后将代码直接粘贴过来存入字符串里 就行 保存好以后就用它了</p><p>然后我们还是一样将 所有服务器启动 然后关掉其中一个user-service</p><p>之后 访问<a href="http://localhost/consumer/2" target="_blank" rel="noopener">http://localhost/consumer/2</a></p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da53.jpg" alt=""></p><p><strong>超时设置</strong></p><p>因为Hystrix的默认超时时长为1秒有点太快了 只要网速稍微有点卡请求就超过1秒 导致请求失败，我们可以通过配置修改这个值；修改 consumer-demo的application.yml 添加如下配置：</p><pre class="line-numbers language-yml"><code class="language-yml">hystrix:
  command:
    default:
      execution:
        isolation:
          thread:
            timeoutInMilliseconds: 2000   # 修改访问超时时间 2秒<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>根据情况 自己在改动把</p><p>如果你想测试你可以到</p><p>user-service里的UserService.java内 的方法中 添加一个休眠2秒</p><p>修改完后记得重启user-service服务</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> UserMapper userMapper<span class="token punctuation">;</span>

    <span class="token keyword">public</span> User <span class="token function">queryById</span><span class="token punctuation">(</span>Long id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后你在测试 就会发现每次请求都超时触发降级 如果你把 休眠取消 那么就恢复了</p><h3 id="服务熔断"><a href="#服务熔断" class="headerlink" title="服务熔断"></a>服务熔断</h3><p>状态机有3个状态：</p><p>Closed：关闭状态（断路器关闭），所有请求都正常访问。</p><p>Open：打开状态（断路器打开），所有请求都会被降级。Hystrix会对请求情况计数，当一定时间内失败请求百</p><p>分比达到阈值，则触发熔断，断路器会完全打开。默认失败比例的阈值是50%，请求次数最少不低于20次。</p><p>Half Open：半开状态，不是永久的，断路器打开后会进入休眠时间（默认是5S）。随后断路器会自动进入半开</p><p>状态。此时会释放部分请求通过，若这些请求都是健康的，则会关闭断路器，否则继续保持打开，再次进行休</p><p>眠计时</p><p>我们可以测试下</p><p>测试前记得将上面案例中的 user-service 里的 UserService.java内的方法中的睡眠给取消了</p><p>修改 consumer-demo 然后重启服务</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>controller<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>hystrix<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>javanica<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>DefaultProperties<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>hystrix<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>javanica<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>HystrixCommand<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Autowired<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>client<span class="token punctuation">.</span>discovery<span class="token punctuation">.</span>DiscoveryClient<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>client<span class="token punctuation">.</span>RestTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"consumer"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@DefaultProperties</span><span class="token punctuation">(</span>defaultFallback <span class="token operator">=</span> <span class="token string">"payment_Global_FallbackMethod"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsumerController</span> <span class="token punctuation">{</span>


    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> RestTemplate restTemplate<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> DiscoveryClient discoveryClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/{id}"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token annotation punctuation">@HystrixCommand</span>
    <span class="token keyword">public</span> String <span class="token function">queryById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> Long id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"太忙了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        String url <span class="token operator">=</span> <span class="token string">"http://user-service/user/"</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token keyword">return</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> String <span class="token function">payment_Global_FallbackMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String str <span class="token operator">=</span> <span class="token string">"&lt;div style=\"width: 100%;text-align: center\">\n"</span> <span class="token operator">+</span>
                <span class="token string">"    &lt;h1 >对不起，网络太拥挤了！ 刷新重试&lt;/h1>\n"</span> <span class="token operator">+</span>
                <span class="token string">"&lt;/div>"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> str<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>你疯狂请求<a href="http://localhost/consumer/1" target="_blank" rel="noopener">http://localhost/consumer/1</a> 大概请求 20~40次左右 就会开启熔断 进入5秒睡眠</p><p>然后快速的访问<a href="http://localhost/consumer/2" target="_blank" rel="noopener">http://localhost/consumer/2</a> 在睡眠期间访问 就会发生 虽然是正确的请求但是还是请求失败</p><p>但是你多刷新几下就成功了 因为5秒睡眠后熔断器进入半开状态 如果在这期间发生请求成功那么 就关闭熔断了</p><p>我们也可以对熔断参数进行配置</p><p>修改 consumer-demo 的application.yml配置</p><pre class="line-numbers language-yml"><code class="language-yml">hystrix:
  command:
    default:
      coreSize: 50    # 线程池核心线程数 默认是10 超过这个数量那么 其他线程就直接进入到 线程池队列等待中
      maxQueueSize: 30 #最大排队长度   默认 -1 不启动线程排队
      queueSizeRejectionThreshold: 10 # 如果 maxQueueSize为-1 这个将失效    线程池队列 默认为5， 超过时拒绝其他线程进入 直接熔断
      circuitBreaker:
        errorThresholdPercentage: 50 # 触发熔断错误比例阈值，默认值50%
        sleepWindowInMilliseconds: 5000 # 短路多久以后开始尝试是否恢复，默认5s
        requestVolumeThreshold: 10 # 熔断触发最小请求次数，默认值是20
      execution:
        isolation:
          semaphore:
            maxConcurrentRequests: 50 # 允许的最大并发请求数  默认10  一般和coreSize设置一样   如果达到最大并发数时，后续请求会被拒绝 直接熔断
          thread:
            timeoutInMilliseconds: 2000   # 修改访问超时时间<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Ribb的超时时间是 &lt; Hystrix熔断的超时。</p><h2 id="Feign声明式客服端"><a href="#Feign声明式客服端" class="headerlink" title="Feign声明式客服端"></a>Feign声明式客服端</h2><p>Feign 简单来说就是 对 consumer-demo的请求进行封装 我们现在都是面向接口编程 所以将consumer-demo内的请求都封装到接口上了 你不需要管consumer-demo请求内部的实现 只要将调用地址给你就行了</p><p>在简单来说consumer-demo 每一个请求的内部 基本都会有好多个请求来请求其他的其他微服务</p><p>在简单来说就是通过一个请求 发送多个请求 然后将返回来的数据进行处理</p><p>而Feign就是将所有的consumer-demo请求进行整理 这样就形成链式调用 各自管理各自的服务</p><p>前端需要数据 只需要找Feign 而 Feign 根据前端的请求找到对应的接口</p><p>而接口在调用对应的consumer-demo内的请求 此刻我们可以发现 Feign 不管你内部怎么实现的 我就是一个秘书找到对应的部门 传达要干什么 然后对应的 consumer-demo部门在去找 完成这件事需要的东西(其他微服务)</p><p>拿现实来说:</p><p>老板告诉秘书 去给我买一辆现在最火的车 然后秘书找到采购部门 告诉老板的需求</p><p>采购部门 也不知道现在最火的是什么车 怎么办 ? 那么他们就需要想其他办法了</p><ol><li>先到网上查最近最火的车然后反馈一个结果 (微服务)</li><li>到当地各个卖车的地方去询问 现在最火的车是什么 然后反馈一个结果 (微服务)</li><li>将所有反馈结果 进行整合 然后选择一个最好的 花钱买下来 然后通知秘书</li><li>秘书在将结果给老板</li></ol><p>这就是 各司其职 各干个的事情 谁也不影响谁</p><p>Feign中本身已经集成了Ribbon依赖和自动配置 因此不需要额外引入依赖，也不需要再注册 RestTemplate 对象。</p><p><strong>接着上面案例继续:</strong></p><p>我们先在<strong>consumer-demo</strong>中ConsumerController里添加一个方法</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>controller<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>hystrix<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>javanica<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>DefaultProperties<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>hystrix<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>javanica<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>HystrixCommand<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Autowired<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>client<span class="token punctuation">.</span>discovery<span class="token punctuation">.</span>DiscoveryClient<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>client<span class="token punctuation">.</span>RestTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"consumer"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@DefaultProperties</span><span class="token punctuation">(</span>defaultFallback <span class="token operator">=</span> <span class="token string">"payment_Global_FallbackMethod"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsumerController</span> <span class="token punctuation">{</span>


    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> RestTemplate restTemplate<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> DiscoveryClient discoveryClient<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//使用了{id}占位符</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/{id}"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token annotation punctuation">@HystrixCommand</span>
    <span class="token keyword">public</span> String <span class="token function">queryById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> Long id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"太忙了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        String url <span class="token operator">=</span> <span class="token string">"http://user-service/user/"</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token keyword">return</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> String <span class="token function">payment_Global_FallbackMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String str <span class="token operator">=</span> <span class="token string">"&lt;div style=\"width: 100%;text-align: center\">\n"</span> <span class="token operator">+</span>
                <span class="token string">"    &lt;h1 >对不起，网络太拥挤了！ 刷新重试&lt;/h1>\n"</span> <span class="token operator">+</span>
                <span class="token string">"&lt;/div>"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> str<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//这个方法是没有使用占位符的 </span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/feign_test"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token annotation punctuation">@HystrixCommand</span>
    <span class="token keyword">public</span> String <span class="token function">queryById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> Integer id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String url <span class="token operator">=</span> <span class="token string">"http://user-service/user/"</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token keyword">return</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后我们开始创建 feign-service服务</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da54.jpg" alt=""></p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da55.jpg" alt=""></p><p>添加Maven</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-netflix-hystrix<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.retry<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-retry<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>添加application.yml配置文件</p><pre class="line-numbers language-yml"><code class="language-yml">#设置端口号
server:
  port: 8083

# 设置  服务名 feign-service
spring:
  application:
    name: feign-service

#注册Eureka
eureka:
  client:
    service-url:
      defaultZone: http://127.0.0.1:10086/eureka,http://127.0.0.1:10087/eureka

feign:
  client:
    config:
      default:
        connectTimeout: 5000 #连接超时
        readTimeout: 5000 #读取超时
  hystrix:  
    enabled: true #开启熔断器

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>FeignApplication 启动类</strong></p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>feign<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>SpringApplication<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>SpringBootApplication<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>eureka<span class="token punctuation">.</span>EnableEurekaClient<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span>EnableFeignClients<span class="token punctuation">;</span>

<span class="token annotation punctuation">@SpringCloudApplication</span>
<span class="token annotation punctuation">@EnableEurekaClient</span> <span class="token comment" spellcheck="true">//开启Eureka客户端</span>
<span class="token annotation punctuation">@EnableFeignClients</span> <span class="token comment" spellcheck="true">//开启Feign客户端</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FeignApplication</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        SpringApplication<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>FeignApplication<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>FeignTestService 接口</strong></p><p>将消费者服务 绑定到接口上和将消费者服务内的请求都绑定到抽象方法上</p><p>也就是此接口 只能访问 绑定的消费者服务内的请求</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>feign<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span>FeignClient<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>RequestMapping<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>RequestMethod<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>RequestParam<span class="token punctuation">;</span>

<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"consumer-service"</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">//绑定需要请求的消费者服务 名称</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">FeignTestService</span> <span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">//绑定consumer-service的请求的抽象方法   </span>
    <span class="token comment" spellcheck="true">//要求返回值 参数  请求类型  必须一致  只有这样才能保证请求的准确性</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"consumer/feign_test"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    String <span class="token function">test1</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> Integer id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 带占位符方式</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"consumer/{id}"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    String <span class="token function">test2</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> Integer id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>FeignTestController</strong></p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>controller<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>FeignTestService<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Autowired<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>GetMapping<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>ResponseBody<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>RestController<span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/feign"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FeignTestController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> FeignTestService feignTestService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/user1"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> String <span class="token function">tes1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> feignTestService<span class="token punctuation">.</span><span class="token function">test1</span><span class="token punctuation">(</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/user2"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> String <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> feignTestService<span class="token punctuation">.</span><span class="token function">test2</span><span class="token punctuation">(</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以上都完成了 将所有服务都打开 进入到<a href="http://localhost:10086/" target="_blank" rel="noopener">http://localhost:10086/</a> 和 <a href="http://localhost:10087/中" target="_blank" rel="noopener">http://localhost:10087/中</a></p><p>看看有没有加载进入Eureka服务</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da56.jpg" alt=""></p><p>然后访问</p><p><a href="http://localhost:8083/feign/user1" target="_blank" rel="noopener">http://localhost:8083/feign/user1</a></p><p><a href="http://localhost:8083/feign/user2" target="_blank" rel="noopener">http://localhost:8083/feign/user2</a></p><p>以上只是简单的 体验一把 我们下面开始将Feign的配置补全</p><p>我们到现在为止 user_service 和eureka-server 都学了怎么集群 那么consumer-demo怎么集群呢?</p><p>很简单只需要 在创建 一个consumer-demo1</p><p>然后将consumer-demo内容复制到consumer-demo1中 将他们端口号改一下</p><p>然后将consumer-demo1的pom.xml里的依赖添补充完整和consumer-demo一样</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da57.jpg" alt=""></p><p>consumer-demo</p><pre class="line-numbers language-yml"><code class="language-yml"># 配置端口号
server:
  port: 8000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>consumer-demo1</p><pre class="line-numbers language-yml"><code class="language-yml"># 配置端口号
server:
  port: 8001<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>其他的都不要动 然后查看Enreka<a href="http://localhost:10087" target="_blank" rel="noopener">http://localhost:10087</a> 或者10086都行</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da58.jpg" alt=""></p><p><strong>接下来我们来修改 feign-service服务 内容</strong></p><p><strong>修改feign-service的application.yml</strong></p><blockquote><p>配置的内容 : 主要是开启 负载均衡 , 超时重试 熔断器</p></blockquote><pre class="line-numbers language-yml"><code class="language-yml">#设置端口号
server:
  port: 8083

# 设置  服务名 feign-service
spring:
  application:
    name: feign-service
  cloud:
    loadbalancer:
      retry:
        enabled: true # 开启Spring Cloud的重试功能
#注册Eureka
eureka:
  client:
    service-url:
      defaultZone: http://127.0.0.1:10086/eureka,http://127.0.0.1:10087/eureka
  ribbon:  #开启重试机制
    ConnectTimeout: 250 # Ribbon的连接超时时间
    ReadTimeout: 1000 # Ribbon的数据读取超时时间
    OkToRetryOnAllOperations: true # 是否对所有操作都进行重试
    MaxAutoRetriesNextServer: 1 # 切换实例的重试次数
    MaxAutoRetries: 1 # 对当前实例的重试次数

feign:
  hystrix:
    enabled: true   #开启hystrix支持

hystrix:
  command:
    default:
      coreSize: 50    # 线程池核心线程数 默认是10 超过这个数量那么 其他线程就直接进入到 线程池队列等待中
      maxQueueSize: 30 #最大排队长度   默认 -1 不启动线程排队
      queueSizeRejectionThreshold: 10 # 如果 maxQueueSize为-1 这个将失效    线程池队列 默认为5， 超过时拒绝其他线程进入 直接熔断
      circuitBreaker:
        errorThresholdPercentage: 50 # 触发熔断错误比例阈值，默认值50%
        sleepWindowInMilliseconds: 5000 # 短路多久以后开始尝试是否恢复，默认5s
        requestVolumeThreshold: 10 # 熔断触发最小请求次数，默认值是20
      execution:
        isolation:
          semaphore:
            maxConcurrentRequests: 5000 # 允许的最大并发请求数  默认10  一般和coreSize设置一样   如果达到最大并发数时，后续请求会被拒绝 直接熔断
          thread:
            timeoutInMilliseconds: 2000   # 修改访问超时时间 当请求超过这个时间就会 调用降级方法


<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>修改 FeignTestController</strong></p><p>然后 添加熔断配置</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>controller<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>FeignTestService<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>hystrix<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>javanica<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>DefaultProperties<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>hystrix<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>javanica<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>HystrixCommand<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Autowired<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>GetMapping<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>ResponseBody<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>RestController<span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/feign"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@DefaultProperties</span><span class="token punctuation">(</span>defaultFallback <span class="token operator">=</span> <span class="token string">"payment_Global_FallbackMethod"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FeignTestController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> FeignTestService feignTestService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/user1"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token annotation punctuation">@HystrixCommand</span>
    <span class="token keyword">public</span> String <span class="token function">tes1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> feignTestService<span class="token punctuation">.</span><span class="token function">test1</span><span class="token punctuation">(</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/user2"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token annotation punctuation">@HystrixCommand</span>
    <span class="token keyword">public</span> String <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> feignTestService<span class="token punctuation">.</span><span class="token function">test2</span><span class="token punctuation">(</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment" spellcheck="true">//降级方法</span>
    <span class="token keyword">public</span> String <span class="token function">payment_Global_FallbackMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String str <span class="token operator">=</span> <span class="token string">"&lt;div style=\"width: 100%;text-align: center\">\n"</span> <span class="token operator">+</span>
                <span class="token string">"    &lt;h1 >对不起，网络太拥挤了！ 刷新重试-----Feign&lt;/h1>\n"</span> <span class="token operator">+</span>
                <span class="token string">"&lt;/div>"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> str<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//测试 熔断是否触发</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/hystrix"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token annotation punctuation">@HystrixCommand</span>
    <span class="token keyword">public</span> String <span class="token function">testHystrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//这个触发了 feign-service 内的 超时处理</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"太忙了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

     <span class="token comment" spellcheck="true">//测试 熔断是否触发</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/hystrix_fe"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> String <span class="token function">testHystrix_fe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//这个触发了  consumer-demo 内的 超时处理</span>
      <span class="token keyword">return</span>   feignTestService<span class="token punctuation">.</span><span class="token function">test2</span><span class="token punctuation">(</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以上配置都修改完了 那么记得重启服务</p><p>我们将所有服务都打开</p><ol><li><p>先测试 熔断器是否好使 我们可以</p><p>访问 <a href="http://localhost:8083/feign/hystrix" target="_blank" rel="noopener">http://localhost:8083/feign/hystrix</a> 和<a href="http://localhost:8083/feign/hystrix_fe" target="_blank" rel="noopener">http://localhost:8083/feign/hystrix_fe</a></p></li><li><p>测试负载均衡 的否 轮询 看consumer-demo和consumer-demo1的控制台打印</p><p>我们可以访问: <a href="http://localhost:8083/feign/user2" target="_blank" rel="noopener">http://localhost:8083/feign/user2</a> 来测试</p></li><li><p>把其中一个consumer-demo关掉看看能否实现 Ribbon重试 也就是页面不报错访问正常</p></li></ol><p>其实在Feign中有内置的重试机制和熔断的 只是配置的方式不一样</p><p>我们需要开启 Feign的重试 然后需要重写 Feign的接口 这</p><p>在没有超时的时候他会默认调用@FeignClient注解 帮你生成的实现类</p><p>如果访问超时等等 那么就会调用你自己实现的接口实现类 返回提示信息</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da61.jpg" alt=""></p><p>将feign-service的application.yml修改下</p><pre class="line-numbers language-yml"><code class="language-yml">#设置端口号
server:
  port: 8083

# 设置  服务名 feign-service
spring:
  application:
    name: feign-service

#注册Eureka
eureka:
  client:
    service-url:
      defaultZone: http://127.0.0.1:10086/eureka,http://127.0.0.1:10087/eureka


feign:
  hystrix:
    enabled: true  #开启hystrix支持

hystrix:
  command:
    default:
      coreSize: 50    # 线程池核心线程数 默认是10 超过这个数量那么 其他线程就直接进入到 线程池队列等待中
      maxQueueSize: 30 #最大排队长度   默认 -1 不启动线程排队
      queueSizeRejectionThreshold: 10 # 如果 maxQueueSize为-1 这个将失效    线程池队列 默认为5， 超过时拒绝其他线程进入 直接熔断
      circuitBreaker:
        errorThresholdPercentage: 50 # 触发熔断错误比例阈值，默认值50%
        sleepWindowInMilliseconds: 5000 # 短路多久以后开始尝试是否恢复，默认5s
        requestVolumeThreshold: 10 # 熔断触发最小请求次数，默认值是20
      execution:
        isolation:
          semaphore:
            maxConcurrentRequests: 5000 # 允许的最大并发请求数  默认10  一般和coreSize设置一样   如果达到最大并发数时，后续请求会被拒绝 直接熔断
          thread:
            timeoutInMilliseconds: 3000   # 修改访问超时时间 当请求超过这个时间就会 调用降级方法
#开启feign内置的重试
ribbon:
  ConnectTimeout: 250 # Ribbon的连接超时时间
  ReadTimeout: 1000 # Ribbon的数据读取超时时间
  OkToRetryOnAllOperations: true # 是否对所有操作都进行重试
  MaxAutoRetriesNextServer: 1 # 切换实例的重试次数
  MaxAutoRetries: 1 # 对当前实例的重试次数<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>修改 FeignTestService 接口</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>feign<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>impl<span class="token punctuation">.</span>UserClientFallback<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span>FeignClient<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>PathVariable<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>RequestMapping<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>RequestMethod<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>RequestParam<span class="token punctuation">;</span>

<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"consumer-service"</span><span class="token punctuation">,</span>fallback <span class="token operator">=</span> UserClientFallback<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">//需要请求的消费者 服务name</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">FeignTestService</span> <span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">//绑定consumer-service的请求   要求返回值 参数  请求类型  必须一致  只有这样才能保证请求的准确性</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"consumer/feign_test"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    String <span class="token function">test1</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> Integer id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"consumer/{id}"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    String <span class="token function">test2</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> Integer id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>创建UserClientFallback实现类</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>impl<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>FeignTestService<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span>Component<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserClientFallback</span> <span class="token keyword">implements</span> <span class="token class-name">FeignTestService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> String <span class="token function">test1</span><span class="token punctuation">(</span>Integer id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"网络太卡了 你慢点 111"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> String <span class="token function">test2</span><span class="token punctuation">(</span>Integer id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"网络太卡了 你慢点 222"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>修改FeignTestController 将不需要的都删除</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>controller<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>FeignTestService<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Autowired<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>GetMapping<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>RequestMapping<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>ResponseBody<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>RestController<span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/feign"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FeignTestController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> FeignTestService feignTestService<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//在IDEA中这个会报红 不要管他</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/user1"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> String <span class="token function">tes1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> feignTestService<span class="token punctuation">.</span><span class="token function">test1</span><span class="token punctuation">(</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/user2"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> String <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> feignTestService<span class="token punctuation">.</span><span class="token function">test2</span><span class="token punctuation">(</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//测试 熔断是否触发</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/hystrix_fe"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> String <span class="token function">testHystrix_fe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>   feignTestService<span class="token punctuation">.</span><span class="token function">test2</span><span class="token punctuation">(</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后 可以开始测试了 访问 <a href="http://localhost:8083/feign/user2" target="_blank" rel="noopener">http://localhost:8083/feign/user2</a></p><p>然后关闭一个 consumer-demo服务 试试 如果出现</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da62.jpg" alt=""></p><p>代表 配置成功</p><p>如果不出现 你多式几次</p><p>我们对比 两种方式 我觉得 还是第一种方式比较好 响应比较稳定</p><p>而且能实现 请求失败的方法 共享 不好的地方就是 代码有点混乱 都写在一起了</p><p>而使用feign内置的 重试+熔断 不太理想 而且因为是从写接口所以每一个请求都绑定了 一个请求失败方法 有点繁琐 响应不稳定</p><p>但是也不能一票否决feign的重试+熔断 也有他们的优势 就是 配置简单 而且 代码分离 结构清晰 比较符合程序的设计逻辑</p><p>第一种方式: 针对于当前服务的指定controller的响应 响应比较稳定因为就是处理本服务内的响应</p><p>第二种使用feign内置的方式: 针对于指定微服务器 内 的所有响应 所以相对于第一种响应会有点不稳 毕竟跨服务器会出现 动不动超时现象</p><p>到现在为止 我们的整个项目结构图:</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da59.jpg" alt=""></p><p><strong>Feign-压缩</strong></p><p>Spring Cloud Feign 支持对请求和响应进行GZIP压缩，以减少通信过程中的性能损耗。通过下面的参数即可开启请求与响应的压缩功能：</p><p>简单来说就是加快访问和响应速度 <strong>建议配置</strong></p><p>直接在feign-service 里的application.yml修改就行</p><pre class="line-numbers language-yml"><code class="language-yml">feign:
  hystrix:
    enabled: true
  compression:
    request:
      enabled: true # 开启请求压缩
      mime-types: text/html,application/xml,application/json # 设置压缩的数据类型
      min-request-size: 2048 # 设置触发压缩的大小下限compression: request: enabled: true # 开启请求压缩 mime-types: text/html,application/xml,application/json # 设置压缩的数据类型 min-request-size: 2048 # 设置触发压缩的大小下限<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>日志级别(了解就行)</strong></p><p>一般也不需要配置 如果需要那么在配置</p><p>前面讲Springboot，可以通过 logging.level.xx=debug 来设置日志级别。然而这个对Fegin客户端而言不会产生效果。因为</p><p>@FeignClient 注解修改的客户端在被代理时，都会创建一个新的Fegin.Logger实例。我们需要额外指定这个日志的级别才可以</p><p>在feign-service 里的application.yml添加就行</p><pre class="line-numbers language-yml"><code class="language-yml">logging:
  level:
    com.itheima: debug<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>编写FeignConfig 配置类，定义日志级别</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>impl<span class="token punctuation">;</span>

<span class="token keyword">import</span> feign<span class="token punctuation">.</span>Logger<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Bean<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Configuration<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FeignConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    Logger<span class="token punctuation">.</span>Level <span class="token function">feignLoggerLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//记录所有请求和响应的明细，包括头信息、请求体、元数据</span>
        <span class="token keyword">return</span> Logger<span class="token punctuation">.</span>Level<span class="token punctuation">.</span>FULL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里指定的Level级别是FULL，Feign支持4种级别：</p><p>NONE：不记录任何日志信息，这是默认值。</p><p>BASIC：仅记录请求的方法，URL以及响应状态码和执行时间</p><p>HEADERS：在BASIC的基础上，额外记录了请求和响应的头信息</p><p>FULL：记录所有请求和响应的明细，包括头信息、请求体、元数据。</p><p>然后在指定的Feign接口类上的@FeignClient注解中指定配置类：</p><pre class="line-numbers language-java"><code class="language-java">configuration<span class="token operator">=</span> FeignConfig<span class="token punctuation">.</span><span class="token keyword">class</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da63.jpg" alt=""></p><p>你给那个接口配置了 那么这个接口的 日志就会变成 上面设置的 debug级别</p><p>重启feign服务 一般项目没什么问题 那么 也测试不出来 了解即可</p><h2 id="Zuul服务网关"><a href="#Zuul服务网关" class="headerlink" title="Zuul服务网关"></a>Zuul服务网关</h2><p>当你把以上配置都完成了 那么就剩下最后一个服务 Zuul：服务网关</p><p>在了解网关前 我们先将feign-service服务集群 也就在创建一个feign服务 同样的内容代码 同样的配置 同样的Mvean依赖 就是端口号不同</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da64.jpg" alt=""></p><p>feign-service</p><pre class="line-numbers language-yml"><code class="language-yml">#设置端口号
server:
  port: 8083<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>feign-service1-1</p><pre class="line-numbers language-yml"><code class="language-yml">#设置端口号
server:
  port: 8084<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>我们将所有服务都启动 访问<a href="http://localhost:10086/看看" target="_blank" rel="noopener">http://localhost:10086/看看</a></p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da65.jpg" alt=""></p><p>以上都完成了 那么我们开始使用网关</p><h3 id="1-为什么需要网关"><a href="#1-为什么需要网关" class="headerlink" title="1. 为什么需要网关"></a>1. 为什么需要网关</h3><p>API网关的出现的原因是微服务架构的出现，不同的微服务一般有不同的网络地址，而外部客户端可能需要调用多个服务的接口才能完成完成一个业务需求，如果让客户端直接与各个微服务通信，会出现以下的问题。</p><ol><li>客户端会多次请求不同的微服务，增加了客户端的复杂性。</li><li>存在跨域请求，在一定场景下处理相对复制。</li><li>认证复杂，每个服务都需要独立的认证。</li><li>难以重构，随着项目的迭代。可能需要重新划分微服务。如果客户端与微服务直接通信，那么重构将会很复杂。</li><li>某些微服务可能使用了防火墙/浏览器不友好的协议，直接访问会有一定的困难。</li></ol><p><strong>以上的问题可以借助API网关来解决。API网关是介于客户端和服务器端之间的中间层，所有的外部请求都会先经过API网关这一层。也就是说，API网关可以完成安全、性能、监控等功能，而服务提供者可以专门的完成具体的业务逻辑。</strong></p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da66.jpg" alt=""></p><p>使用API网关的优点：</p><ol><li>易于监控，可以在网关收集监控数据并将其推送到外部系统进行分析；</li><li>易于认证，可以在网关进行认证，然后再将请求转发到后端的微服务，而无需在每个微服务中进行认证；</li><li>减少客户端和各个微服务之间的交互次数。</li></ol><h3 id="2-创建网关服务"><a href="#2-创建网关服务" class="headerlink" title="2 .创建网关服务"></a>2 .创建网关服务</h3><p>我们创建一个gateway-service服务</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da67.jpg" alt=""></p><p>添加Maven</p><pre class="line-numbers language-xml"><code class="language-xml">   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>application.yml</p><pre class="line-numbers language-yml"><code class="language-yml"># 设置端口号
server:
  port: 10010

# 设置  服务名 为gateway-service
spring:
  application:
    name: gateway-service
  cloud:
    gateway:
      routes:
        # 路由id，可以随意写不影响  一般都是以要代理的服务器名称-route
        - id: feign-service-route
          uri: lb://feign-service # 要代理的服务器名称 (集群的时候可以防止宕机)
          #我们请求http://127.0.0.1:10010/xxxx 会被拦截 如果路径包含指定的路径 那么就执行对应的路由地址
          predicates: #允许的路由地址
            - Path=/feign/user1/**

        # 路由id，可以随意写 不影响 不能重复  一般都是以要代理的服务器名称-route
        - id: feign-service-route1
          uri: lb://feign-service # 要代理的服务器地址
          #我们请求http://127.0.0.1:10010/xxx 会被拦截 如果路径包含指定的路径 那么就执行对应的路由地址
          predicates: #允许的路由地址
            - Path=/feign/user2/**

        # 路由id，可以随意写 不影响 不能重复  一般都是以要代理的服务器名称-route
        - id: user_service-route
          uri: lb://user-service # 要代理的服务器地址
          #我们请求http://127.0.0.1:10010/xxx 会被拦截 如果路径包含指定的路径 那么就执行对应的路由地址
          predicates: #允许的路由地址
            - Path=/user/**


#注册Eureka
eureka:
  client:
    service-url:
      defaultZone: http://127.0.0.1:10086/eureka,http://127.0.0.1:10087/eureka
  instance:
    prefer-ip-address: true #使用IP作为注册而不是主机名(默认是主机名称);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>GatewayApplication(启动类)</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>gateway<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>SpringApplication<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>SpringBootApplication<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>client<span class="token punctuation">.</span>discovery<span class="token punctuation">.</span>EnableDiscoveryClient<span class="token punctuation">;</span>

<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GatewayApplication</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        SpringApplication<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>GatewayApplication<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以上配置完成启动服务 访问<a href="http://localhost:10086/" target="_blank" rel="noopener">http://localhost:10086/</a></p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da68.jpg" alt=""></p><p>这里解释下application.yml中的routes的配置</p><ol><li>id 是路由的名称</li><li>url 是要访问的服务器</li><li>predicates.path 是允许的路由地址</li></ol><p>当用户访问<code>http://127.0.0.1:10010/feign/user1</code> 的时候会判断predicates.path中有有没有/feign/user1 这个路径</p><p>而在上面我们 是允许/feign/user1和他之后的所有路径的 也就是满足条件</p><p>那么网关就会 帮你访问feign-service服务内的/feign/user1这个地址 拼接后的完整地址 <code>http://127.0.0.1:8083/feign/user1</code></p><p>我们 uri设置的是服务器的名称不是ip 这样的好处就是 如果集群 其中一个宕机了 那么会将请求交给集群中的下一个正常的服务</p><p>提示:</p><p>我们可以访问多个不同的服务(跨域) 只需要在配置一套就行 上面有演示</p><p>如果要访问的不是注册中心eureka里的服务 而是其他的服务 是没有服务名称的 可以使用 <code>uri: http://127.0.0.1:9091</code></p><p>但是这样配置的话如果这个服务宕机的话那么就访问不了了</p><p>注意的是 id 和 Path不要重复了 否则就会找不到你要路由的是哪一个服务</p><p>然后我们开始测试</p><p><a href="http://127.0.0.1:10010/feign/user1" target="_blank" rel="noopener">http://127.0.0.1:10010/feign/user1</a></p><p><a href="http://127.0.0.1:10010/feign/user2" target="_blank" rel="noopener">http://127.0.0.1:10010/feign/user2</a></p><p><a href="http://127.0.0.1:10010/user/2" target="_blank" rel="noopener">http://127.0.0.1:10010/user/2</a></p><p>以上请求都没问题 证明 我们网关搭建成功</p><h3 id="3-内置过滤器-可以不配置解就行"><a href="#3-内置过滤器-可以不配置解就行" class="headerlink" title="3.内置过滤器(可以不配置解就行)"></a>3.内置过滤器(可以不配置解就行)</h3><p>Gateway自带过滤器有几十个 常见自带过滤器有:</p><p>AddRequestHeader 对匹配上的请求加上Header</p><p>AddRequestParameters 对匹配上的请求路由添加参数</p><p>AddResponseHeader 对从网关返回的响应添加Header</p><p>StripPrefifix 对匹配上的请求路径去除前缀</p><p>PrefixPath 对匹配上的请求路径 添加前缀</p><p><strong>添加前缀</strong></p><pre class="line-numbers language-yml"><code class="language-yml">       # 路由id，可以随意写 不影响 不能重复  一般都是以要代理的服务器名称-route
        - id: feign-service-route1
          uri: lb://feign-service # 要代理的服务器地址
          #我们请求http://127.0.0.1:10010/xxx 会被拦截 如果路径包含指定的路径 那么就执行对应的路由地址
          predicates: #允许的路由地址
            - Path=/user2/**
          filters: # 添加请求路径的前缀
            #访问的时候http://127.0.0.1:10010/user2就行了 省略/feign  
            #但是实际上会自动给你在前面补上http://127.0.0.1:10010/feign/user2
            - PrefixPath=/feign<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>去除前缀</strong></p><p>和添加前缀相反</p><pre class="line-numbers language-yml"><code class="language-yml">        # 路由id，可以随意写 不影响 不能重复  一般都是以要代理的服务器名称-route
        - id: feign-service-route1
          uri: lb://feign-service # 要代理的服务器地址
          #我们请求http://127.0.0.1:10010/xxx 会被拦截 如果路径包含指定的路径 那么就执行对应的路由地址
          predicates: #允许的路由地址
            - Path=/abc/feign/user1/**
          filters: # 去除请求的前缀
            #访问的时候http://127.0.0.1:10010/abc/feign/user1
            #但是实际上会将你前面的/abc给去掉 http://127.0.0.1:10010/feign/user1
            - StripPrefix=1  #StripPrefix=2 代表就是去掉前2个 以此类推<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>组合使用</strong></p><p>这样可以很好的隐藏实际的url</p><pre class="line-numbers language-yml"><code class="language-yml">        # 路由id，可以随意写 不影响 不能重复  一般都是以要代理的服务器名称-route
        - id: feign-service-route1
          uri: lb://feign-service # 要代理的服务器地址
          #我们请求http://127.0.0.1:10010/xxx 会被拦截 如果路径包含指定的路径 那么就执行对应的路由地址
          predicates: #允许的路由地址
            - Path=/abc/user1/**
          filters: #路径过滤
            #访问的时候http://127.0.0.1:10010/abc/user1/
            - StripPrefix=1  #删除前缀/abc
            - PrefixPath=/feign #添加前缀 /feign
            #最后结果 也就是实际访问的地址 /feign/user1/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意 添加前缀 和 去除前缀的顺序 如果删除在前 那么就是先删除然后 在添加 以此类推</p><p><strong>全局响应头过滤器(了解就行)</strong></p><p>这个作用就是在每次访问的时候都会在请求头中添加 一些信息</p><p>修改application.yml配置文件</p><pre class="line-numbers language-yml"><code class="language-yml"># 设置  服务名 为gateway-service
spring:
  application:
    name: gateway-service
  cloud:
    gateway:
      default-filters:
        # 响应头过滤器，对输出的响应设置其头部属性名称为X-Response-Default-MyName，值为itcast； 如果有多个参数多则重写一行设置不同的参数
        - AddResponseHeader=X-Response-Default-MyName, itcast
      routes:
      省略............<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>设置完重启 gateway-service服务</p><p>访问<a href="http://127.0.0.1:10010/feign/user1" target="_blank" rel="noopener">http://127.0.0.1:10010/feign/user1</a></p><p>按下F12 打开网络 在火狐狸 有时候 还需要重新载入 才能看到</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da69.jpg" alt=""></p><p>获取请求头数据：request方法</p><p>String getHeader(String name)：通过请求头的名称获取请求头的值</p><p>Enumeration getHeaderNames():获取所有的请求头名称</p><pre class="line-numbers language-java"><code class="language-java"> <span class="token comment" spellcheck="true">//获取所有请求头名称</span>
        Enumeration<span class="token operator">&lt;</span>String<span class="token operator">></span> headerNames <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeaderNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>headerNames<span class="token punctuation">.</span><span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            String name <span class="token operator">=</span> headerNames<span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//根据名称获取请求头的值</span>
            String value <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name<span class="token operator">+</span><span class="token string">"---"</span><span class="token operator">+</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在请求头中添加信息 就是一个标记的作用 这个标记你想让他完成什么功能 就完成什么功能</p><p>比如权限管理:如果你的请求头中没有我指定的信息那么 我可以认为是非法请求 不允许访问</p><h3 id="4-自定义过滤器-可以不配置解就行"><a href="#4-自定义过滤器-可以不配置解就行" class="headerlink" title="4.自定义过滤器(可以不配置解就行)"></a>4.自定义过滤器(可以不配置解就行)</h3><p>就是在用户请求的时候 进行拦截 然后 检测 是否符合 要求</p><p>比如账号密码验证 比如 路径参数验证 比如权限验证 ……</p><p>自定义过滤器分为全局自定义过滤器 和 局部自定义过滤器</p><p>全局过滤器是针对所有网关的请求 而 自定义过滤器是针对指定的请求需要单独配置</p><h4 id="局部自定义过滤器"><a href="#局部自定义过滤器" class="headerlink" title="局部自定义过滤器"></a>局部自定义过滤器</h4><p>局部过滤一般都是针对指定的请求进行处理的</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da70.jpg" alt=""></p><p>MyParamGatewayFilterFactory</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyParamGatewayFilterFactory</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractGatewayFilterFactory</span><span class="token operator">&lt;</span>MyParamGatewayFilterFactory<span class="token punctuation">.</span>Config<span class="token operator">></span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String PARAM_NAME <span class="token operator">=</span> <span class="token string">"param"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Config</span> <span class="token punctuation">{</span>

        <span class="token keyword">private</span> String param<span class="token punctuation">;</span>

        <span class="token keyword">public</span> String <span class="token function">getParam</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> param<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setParam</span><span class="token punctuation">(</span>String param<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>param <span class="token operator">=</span> param<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token function">MyParamGatewayFilterFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>Config<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token function">shortcutFieldOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>PARAM_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> GatewayFilter <span class="token function">apply</span><span class="token punctuation">(</span>Config config<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        GatewayFilter gatewayFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GatewayFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> Mono<span class="token operator">&lt;</span>Void<span class="token operator">></span> <span class="token function">filter</span><span class="token punctuation">(</span>ServerWebExchange exchange<span class="token punctuation">,</span> GatewayFilterChain chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">/**
                 * 拦截所有请求，如果参数中包含name,把参数打印到控制台
                 */</span>
                <span class="token comment" spellcheck="true">//获取请求对象</span>
                ServerHttpRequest request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//判断路径中key是否包含</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getQueryParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>param<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    request<span class="token punctuation">.</span><span class="token function">getQueryParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>param<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>value <span class="token operator">-</span><span class="token operator">></span> System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"----------局部过滤器-----%s = %s-----"</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>param<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//放行所有请求</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> gatewayFilter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里注意:</p><p>自定义过滤器的命名后缀应该为：***GatewayFilterFactory 这是必须的 否则就会找不到你定义的类</p><p>然在配置文件中filters:下面添加 - MyParam=name</p><p>MyParam就是前缀 而 name 就是参数</p><p>我们在自定义局部过滤类中通过 config.param就能获取到</p><p>当然你也可以不设置 直接 - MyParam 那么在内容使用config.param就等于” “</p><pre class="line-numbers language-yml"><code class="language-yml">         routes:
        # 路由id，可以随意写不影响  一般都是以要代理的服务器名称-route
        - id: feign-service-route
          uri: lb://feign-service # 要代理的服务器名称 (集群的时候可以防止宕机)
          #我们请求http://127.0.0.1:10010/xxxx 会被拦截 如果路径包含指定的路径 那么就执行对应的路由地址
          predicates: #允许的路由地址
            - Path=/feign/user1/**
          filters:
            - # 添加自定义局部过滤器
            - MyParam=name<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们访问<a href="http://127.0.0.1:10010/feign/user1" target="_blank" rel="noopener">http://127.0.0.1:10010/feign/user1</a> 控制台没有效果</p><p><a href="http://127.0.0.1:10010/feign/user1?name=111" target="_blank" rel="noopener">http://127.0.0.1:10010/feign/user1?name=111</a> 控制台就会打印</p><blockquote><p>———-局部过滤器—–name = 111—–</p></blockquote><h4 id="自定义全局过滤器"><a href="#自定义全局过滤器" class="headerlink" title="自定义全局过滤器"></a>自定义全局过滤器</h4><p>这里要注意 全局过滤是在 局部过滤之前执行的</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da71.jpg" alt=""></p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyGlobalFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> Ordered <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Mono<span class="token operator">&lt;</span>Void<span class="token operator">></span> <span class="token function">filter</span><span class="token punctuation">(</span>ServerWebExchange exchange<span class="token punctuation">,</span> GatewayFilterChain chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"-----------------全局过滤器MyGlobalFilter------------------- --"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 获取路径参数中指定的key对应的value值</span>
        String token <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueryParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//判断token是否为空的 </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//返回一个301状态 没有权限</span>
            exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span>HttpStatus<span class="token punctuation">.</span>UNAUTHORIZED<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//放行 </span>
        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//值越小越先执行</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>无效配置任何东西 自动生效</p><p><a href="http://127.0.0.1:10010/feign/user1" target="_blank" rel="noopener">http://127.0.0.1:10010/feign/user1</a> 会发现白屏什么都没有 我们按F12找到请求的路径发现状态码变成了301</p><p><a href="http://127.0.0.1:10010/feign/user1?token=111" target="_blank" rel="noopener">http://127.0.0.1:10010/feign/user1?token=111</a> //请求成功</p><h4 id="在过滤器中进行重定向和打印消息"><a href="#在过滤器中进行重定向和打印消息" class="headerlink" title="在过滤器中进行重定向和打印消息"></a>在过滤器中进行重定向和打印消息</h4><p>如果我们想在局部过滤或者全局过滤的时候进行重定向 或者将消息显示在页面上怎么办?</p><p>我们可以分析下源码 通过返回值chain.filter(exchange) 我们可以看出来 要求返回的是 Mono&lt;Void&gt;类型</p><p>那么我们可以写一个 返回值为Mono&lt;Void&gt;方法 就行了 然后在我们想要操作的地方调用就ok</p><p><strong>重定向</strong></p><pre class="line-numbers language-java"><code class="language-java">    <span class="token comment" spellcheck="true">//重定向</span>
    <span class="token keyword">private</span> Mono<span class="token operator">&lt;</span>Void<span class="token operator">></span> <span class="token function">fallBack</span><span class="token punctuation">(</span>String url<span class="token punctuation">,</span>ServerWebExchange exchange<span class="token punctuation">)</span><span class="token punctuation">{</span>

        ServerHttpResponse response <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span>HttpStatus<span class="token punctuation">.</span>SEE_OTHER<span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"Location"</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>打印消息</strong></p><pre class="line-numbers language-java"><code class="language-java">    <span class="token comment" spellcheck="true">//打印消息</span>
    <span class="token keyword">private</span> Mono<span class="token operator">&lt;</span>Void<span class="token operator">></span> <span class="token function">returnMessage</span><span class="token punctuation">(</span>String resultStr<span class="token punctuation">,</span>ServerWebExchange exchange<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        ServerHttpResponse response <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        HttpStatus httpStatus <span class="token operator">=</span> HttpStatus<span class="token punctuation">.</span>OK<span class="token punctuation">;</span>

        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bits <span class="token operator">=</span> resultStr<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span>StandardCharsets<span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>

        DataBuffer buffer <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">bufferFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>bits<span class="token punctuation">)</span><span class="token punctuation">;</span>

        response<span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span>httpStatus <span class="token operator">==</span> null <span class="token operator">?</span> HttpStatus<span class="token punctuation">.</span>OK <span class="token operator">:</span> httpStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//指定网页解析格式和字符编码，否则在浏览器中会中文乱码</span>
        <span class="token comment" spellcheck="true">//response.getHeaders().add("Content-Type", "text/plain;charset=UTF-8");  //存文本模式</span>
        <span class="token comment" spellcheck="true">//response.getHeaders().add("Content-Type", "application/json;charset=UTF-8");  //解析json格式 如果不是json就报错</span>
        <span class="token comment" spellcheck="true">//response.getHeaders().add("Content-Type", "application/xml;charset=UTF-8");  //解析xml格式 如果不是xml就报错</span>
        response<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"text/html;charset=UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//会解析html 格式的文本</span>
        <span class="token comment" spellcheck="true">//以上都是目前常用的文本解析 选一个就行了</span>
        <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">writeWith</span><span class="token punctuation">(</span>Mono<span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>局部过滤 比如这样 (经提供参考)</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> GatewayFilter <span class="token function">apply</span><span class="token punctuation">(</span>Config config<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        GatewayFilter gatewayFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GatewayFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> Mono<span class="token operator">&lt;</span>Void<span class="token operator">></span> <span class="token function">filter</span><span class="token punctuation">(</span>ServerWebExchange exchange<span class="token punctuation">,</span> GatewayFilterChain chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token comment" spellcheck="true">//获取请求对象</span>
                ServerHttpRequest request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">//如果请求参数中没有 包含指定的key   </span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>request<span class="token punctuation">.</span><span class="token function">getQueryParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>param<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">//那么就跳转到百度</span>
                  <span class="token keyword">return</span>   <span class="token function">fallBack</span><span class="token punctuation">(</span><span class="token string">"https://www.baidu.com"</span><span class="token punctuation">,</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">//获取所有参数</span>
                MultiValueMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> queryParams <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getQueryParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//通过key获取参数列表   然后打印到控制台</span>
                queryParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>param<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>value <span class="token operator">-</span><span class="token operator">></span> System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"----------局部过滤器-----%s = %s-----"</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>param<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//放行所有请求</span>
                <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> gatewayFilter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>全局过滤比如这样 (经提供参考)</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Mono<span class="token operator">&lt;</span>Void<span class="token operator">></span> <span class="token function">filter</span><span class="token punctuation">(</span>ServerWebExchange exchange<span class="token punctuation">,</span> GatewayFilterChain chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"-----------------全局过滤器MyGlobalFilter------------------- --"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 获取路径参数中指定的key</span>
        String token <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueryParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//如果没有token</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//在页面上显示ERROR</span>
            <span class="token keyword">return</span>  <span class="token function">returnMessage</span><span class="token punctuation">(</span><span class="token string">"&lt;h1 align='center'>ERROR&lt;/h1>"</span><span class="token punctuation">,</span> exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//放行</span>
        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-负载均衡和熔断"><a href="#5-负载均衡和熔断" class="headerlink" title="5. 负载均衡和熔断"></a>5. 负载均衡和熔断</h3><p>Gateway中默认就已经集成了Ribbon负载均衡和Hystrix熔断机制。但是所有的超时策略都是走的默认值，比如熔断超时时间只有1S，很容易就触发了。因此建议手动进行配置：</p><p>在gateway-service服务下的application.yml添加</p><pre class="line-numbers language-yml"><code class="language-yml">hystrix:
  command:
    default:
      execution:
        isolation:
          thread:
            timeoutInMilliseconds: 6000  #熔断超时时间
ribbon:
  ConnectTimeout: 1000   # 请求连接的超时时间
  ReadTimeout: 2000     # 请求处理的超时时间
  MaxAutoRetries: 1  #最大重试几次
  MaxAutoRetriesNextServer: 1 #切换实例的重试次数<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="6-Gateway跨域配置"><a href="#6-Gateway跨域配置" class="headerlink" title="6.Gateway跨域配置"></a>6.Gateway跨域配置</h3><p>一般网关都是所有微服务的统一入口，必然在被调用的时候会出现跨域问题。</p><p><strong>跨域</strong>：在js请求访问中，如果访问的地址与当前服务器的域名、ip或者端口号不一致则称为跨域请求。若不解决则不能获取到对应地址的返回结果。</p><p>如：从在<a href="http://localhost:9090中的js访问">http://localhost:9090中的js访问</a> <a href="http://localhost:9000的数据，因为端口不同，所以也是跨域请求。">http://localhost:9000的数据，因为端口不同，所以也是跨域请求。</a></p><p>在一台电脑上可能感受不到 你将上面微服务服务放入到各自服务器上你访问的时候就会出现问题</p><p>在访问Spring Cloud Gateway网关服务器的时候，出现跨域问题的话；可以在网关服务器中通过配置解决，允许哪</p><p>些服务是可以跨域请求的；具体配置如下：</p><p>在gateway-service服务下的application.yml添加</p><pre class="line-numbers language-yml"><code class="language-yml">spring:
  application:
    name: gateway-service
  cloud:
    gateway:
      globalcors:
        cors-configurations:
          '[/**]':
            allow-credentials: true #允许携带认证信息Cookie
            allowed-origins:  # 我们可以通过域名的方式 也可以通过ip  还可以 allowed-origins: * #放行所有跨域请求
              - "http://localhost:8083"  #ip
            allowed-headers: "*"   #允许所有请求头
            allowed-methods:  #允许指定的请求方式
              - OPTIONS
              - GET
              - POST
            max-age: 86400  # 86400 秒，也就是 24 小时 在有效时间内，浏览器无须为同一请求再次发起预检请求，可以减少发送请求的次数，减少系统部分压力。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="无法负载均衡的问题"><a href="#无法负载均衡的问题" class="headerlink" title="无法负载均衡的问题"></a>无法负载均衡的问题</h2><p>上面案例中Gateway还没有集群 如果集群想集群方式是一样的 复制一份改下端口号就行 (了解就行 没必要配置)</p><p>我们都知道负载均衡是通过Eureka中心来给你分配请求以及如果宕机了重试机制</p><p>不管你怎么集群 肯定会有一个服务要作为客户端也就是 外部访问的地方 既然是客户端那么 就只能有一个 不然我到底将请求给谁?</p><p>如果绑定过域名就知道了 域名是需要指定ip的 而这个ip是唯一的 对应着服务器公网ip 这是唯一的</p><p>用户请求通过域名找到这个ip的服务器 然后这个服务器在更具你请求的内容 将请求转发到能干这件事的</p><p>微服务的务器上 处理后将结果在返回到客户端服务器 然后客户端服务器在将结果响应给客户</p><p>还有就是作为客户端的服务器 必须要性能比较好 因为所有的请求都是经过他来转发和响应 需要抗压比较好</p><p>而其他的服务可以更具 访问量来 自行调整</p><p>我们一般使用Gateway作为客户端 但是无法通过Eureka进行负载均衡， 如果你这个服务器宕机了 那么用户的请求也就发送不出去了 那么该怎么办？</p><p>此时，可以使用其它的服务网关，来对Gateway进行代理。比如：Nginx</p><h2 id="Gateway与Feign的区别"><a href="#Gateway与Feign的区别" class="headerlink" title="Gateway与Feign的区别"></a>Gateway与Feign的区别</h2><p>我们可以感觉到Gateway和Feign其实是很类似的 但是他们应用范围不同</p><p><strong>Gateway:</strong> 作为整个应用的流量入口，接收所有的请求，如PC、移动端等，并且将不同的请求转发至不同的处理</p><p>微服务模块，其作用可视为nginx；大部分情况下用作权限鉴定、服务端流量控制</p><p><strong>Feign:</strong> 则是将当前微服务的部分服务接口暴露出来，并且主要用于各个微服务之间的服务调用</p><h2 id="改造上面案例"><a href="#改造上面案例" class="headerlink" title="改造上面案例"></a>改造上面案例</h2><p>还有就是上面案例中我们搭建了 consumer-demo , feign-service , gateway-service 这三个服务</p><p>但是实际上 只需要二个就行了 我们上面的案例将这三个都串联到一起了 只是为了学习</p><p>用户发送请求-&gt;gateway-service -&gt; feign-service-&gt;consumer-demo-&gt;user_service</p><p>user_service获取到数据 然后在一层一层的向上返回响应结果 这样做是不是很傻 而且还浪费资源</p><p>我们实际上可以直接 gateway-service-&gt;feign-service &gt;user_service 就行了 把consumer-demo丢弃</p><p>然后父工程的pom.xml里会报错 需要将报错的地方删除 如果没有报错那么跳过</p><p>consumer-demo在上面案例中 主要就是来演示的 实际开发中用不到</p><p>下面我就来改代码</p><p>然后修feign-service集群的代码</p><ol><li>更换接口中请求的服务器user-service</li><li>更换接口中请求的地址</li><li>修改熔断器实现类</li><li>修改Controller</li></ol><p>FeignTestService接口</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">//需要请求的消费者 服务name          熔断                                         日志</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"user-service"</span><span class="token punctuation">,</span>fallback <span class="token operator">=</span> UserClientFallback<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>configuration<span class="token operator">=</span> FeignConfig<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">FeignTestService</span> <span class="token punctuation">{</span>

<span class="token comment" spellcheck="true">//绑定consumer-service的请求   要求返回值 参数  请求类型  必须一致  只有这样才能保证请求的准确性</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/user/{id}"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
String <span class="token function">test2</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> Integer id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>UserClientFallback实现类</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserClientFallback</span> <span class="token keyword">implements</span> <span class="token class-name">FeignTestService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> String <span class="token function">test2</span><span class="token punctuation">(</span>Integer id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"网络太卡了 你慢点 222"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>FeignTestController</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/feign"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FeignTestController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> FeignTestService feignTestService<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//在IDEA中这个会报红 不要管他</span>


    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/user2"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> String <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> feignTestService<span class="token punctuation">.</span><span class="token function">test2</span><span class="token punctuation">(</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//测试 熔断是否触发</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/hystrix_fe"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> String <span class="token function">testHystrix_fe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>   feignTestService<span class="token punctuation">.</span><span class="token function">test2</span><span class="token punctuation">(</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>修改gateway-service服务的application.yml 配置</p><pre class="line-numbers language-yml"><code class="language-yml"># 设置端口号
server:
  port: 10010

# 设置  服务名 为gateway-service
spring:
  application:
    name: gateway-service
  cloud:
    gateway:
      globalcors:
        cors-configurations:
          '[/**]':
            allow-credentials: true #允许携带认证信息Cookie
            allowed-origins:  # 我们可以通过域名的方式 也可以通过ip  还可以 allowed-origins: * #放行所有跨域请求
              - "http://localhost:8083"  #ip
            allowed-headers: "*"   #允许所有请求头
            allowed-methods:  #允许指定的请求方式
              - OPTIONS
              - GET
              - POST
            max-age: 86400  # 86400 秒，也就是 24 小时 在有效时间内，浏览器无须为同一请求再次发起预检请求，可以减少发送请求的次数，减少系统部分压力。
      routes:
        # 路由id，可以随意写不影响  一般都是以要代理的服务器名称-route
        - id: feign-service-route
          uri: lb://feign-service # 要代理的服务器名称 (集群的时候可以防止宕机)
          #我们请求http://127.0.0.1:10010/xxxx 会被拦截 如果路径包含指定的路径 那么就执行对应的路由地址
          predicates: #允许的路由地址
            - Path=/feign/user2/**

#注册Eureka
eureka:
  client:
    service-url:
      defaultZone: http://127.0.0.1:10086/eureka,http://127.0.0.1:10087/eureka
  instance:
    prefer-ip-address: true #使用IP作为注册而不是主机名(默认是主机名称);


hystrix:
  command:
    default:
      execution:
        isolation:
          thread:
            timeoutInMilliseconds: 6000  #熔断超时时间
ribbon:
  ConnectTimeout: 1000   # 请求连接的超时时间
  ReadTimeout: 2000     # 请求处理的超时时间
  MaxAutoRetries: 1  #最大重试几次
  MaxAutoRetriesNextServer: 1 #切换实例的重试次数<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后把上面案例中所有自定义的滤器类都删除掉 没有特殊需求一般情况都不使用过滤器的</p><p>然后现在我们整体项目结构</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da73.jpg" alt=""></p><p>然后重启服务器所有服务</p><p>访问<a href="http://localhost:10086/" target="_blank" rel="noopener">http://localhost:10086/</a></p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da72.jpg" alt=""></p><p>然后访问 <a href="http://127.0.0.1:10010/feign/user2" target="_blank" rel="noopener">http://127.0.0.1:10010/feign/user2</a> 能访问成功就 ok</p><p>现在的访问流程就是 用户发送请求 -&gt;gateway-service-&gt;feign-service-&gt;user_service(应用服务)</p><p>而负载均衡 和熔断器 宕机重试 等 都是 在feign-service中完成</p><h2 id="Git配置管理"><a href="#Git配置管理" class="headerlink" title="Git配置管理"></a>Git配置管理</h2><p>知名的Git远程仓库有国外的GitHub和国内的码云（gitee）；但是使用GitHub时，国内的用户经常遇到的问题是访</p><p>问速度太慢，有时候还会出现无法连接的情况。如果希望体验更好一些，可以使用国内的Git托管服务——码云</p><p>（gitee.com）。</p><p>与GitHub相比，码云也提供免费的Git仓库。此外，还集成了代码质量检测、项目演示等功能。对于团队协作开发，</p><p>码云还提供了项目管理、代码托管、文档管理的服务。本章中使用的远程Git仓库是码云。</p><p>码云访问地址：<a href="https://gitee.com/" target="_blank" rel="noopener">https://gitee.com/</a></p><h3 id="创建远程仓库"><a href="#创建远程仓库" class="headerlink" title="创建远程仓库"></a>创建远程仓库</h3><p>首先要使用码云上的私有远程git仓库需要先注册帐号；请先自行访问网站并注册帐号，然后使用帐号登录码云控制台并创建公开仓库</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da74.jpg" alt=""></p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da75.jpg" alt=""></p><h3 id="在仓库里创建配置文件"><a href="#在仓库里创建配置文件" class="headerlink" title="在仓库里创建配置文件"></a>在仓库里创建配置文件</h3><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da76.jpg" alt=""></p><p>在新建的仓库中创建需要被统一配置管理的配置文件。</p><p><strong>配置文件的命名方式</strong>：{<strong>application</strong>}-{<strong>profifile</strong>}.yml 或 {application}-{profifile}.properties</p><p>application为应用名称</p><p>profifile用于区分开发环境，测试环境、生产环境等</p><p>如<strong>user-dev.yml</strong>，表示用户微服务开发环境下使用的配置文件。</p><p>这里将user-service工程的配置文件application.yml文件的内容复制作为user-dev.yml文件的内容，具体配置如下</p><pre class="line-numbers language-yml"><code class="language-yml"># 设置端口号
server:
  port: 9091

# 设置  服务名 为user-service
spring:
  application:
    name: user-service
  # 配置数据库 参数
  datasource:
    driver-class-name: com.mysql.jdbc.Driver
    url: jdbc:mysql://localhost:3306/springcloud
    username: root
    password: root
#配置 mybatis 的 实体层
mybatis:
  type-aliases-package: com.itheima.user.entity
#注册Eureka
eureka:
  client:
    service-url:
      defaultZone: http://127.0.0.1:10086/eureka,http://127.0.0.1:10087/eureka
  instance:
    ip-address: 127.0.0.1   #此ip地址注册到Eureka中
    prefer-ip-address: true #使用ip作为地址  如果为fasle 就是本机的Ip地址
    lease-expiration-duration-in-seconds: 90    # 发呆时间，即服务续约到期时间（缺省为90s）
    lease-renewal-interval-in-seconds: 30    # 心跳时间，即服务续约间隔时间（缺省为30s）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud//img/da77.png" alt=""></p><p>以上都完成了那么 我们就开始搭建<strong>搭建配置中心微服务</strong></p><h3 id="搭建配置中心微服务"><a href="#搭建配置中心微服务" class="headerlink" title="搭建配置中心微服务"></a>搭建配置中心微服务</h3><p>接着上面的项目 创建一个子工程 config-server</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da78.jpg" alt=""></p><p>添加Maven依赖</p><pre class="line-numbers language-xml"><code class="language-xml">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-config-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后添加application.yml配置文件</p><pre class="line-numbers language-yml"><code class="language-yml">#设置端口号
server:
  port: 12000

# 设置  服务名 config-server
spring:
  application:
    name: config-server
  cloud:
    config:
      server:
        git:
         uri: https://gitee.com/huanminabc/weifuwu-config  #码云 配置文件仓库地址

#注册Eureka
eureka:
  client:
    service-url:
      defaultZone: http://127.0.0.1:10086/eureka,http://127.0.0.1:10087/eureka<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>提示: 这里的git.uri xxx 是你的码云或者github 的配置文件的仓库地址</p><p>启动类</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>config<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>SpringApplication<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>SpringBootApplication<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>config<span class="token punctuation">.</span>server<span class="token punctuation">.</span>EnableConfigServer<span class="token punctuation">;</span>

<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableConfigServer</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigServerApplication</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        SpringApplication<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>ConfigServerApplication<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以上都完成了 那么将所有的 服务启动 然后访问</p><p><a href="http://localhost:12000/user-dev.yml" target="_blank" rel="noopener">http://localhost:12000/user-dev.yml</a></p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da79.jpg" alt=""></p><p>到这里表示我们配置中心搭建完成 那么我们就可以将其他 微服务服务 的配置文件进行转移到码云中了 集中管理</p><h3 id="获取配置中心配置"><a href="#获取配置中心配置" class="headerlink" title="获取配置中心配置"></a>获取配置中心配置</h3><p><strong>一定要仔细看 每一句话 否则你会发现搭着搭着 莫名其名 服务启动不了</strong></p><p>前面已经完成了配置中心微服务的搭建，下面我们就需要改造一下用户微服务 user-service ，配置文件信息不再由微服务项目提供，而是从配置中心获取。如下对 user-service 工程进行改造。</p><p>在 user-service 工程中的pom.xml文件中添加如下依赖</p><pre class="line-numbers language-xml"><code class="language-xml">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><strong>删除原来的配置文件application.yml 添加新的bootstrap.yml配置文件</strong></p><p>bootstrap.yml内容如下</p><pre class="line-numbers language-yml"><code class="language-yml">spring:
  cloud:
    config:
      name: user     # 与远程仓库中的配置文件的application保持一致
      profile: dev   # 远程仓库中的配置文件的profile保持一致
      label: master   # 远程仓库中(分支名称)
      discovery:
        enabled: true  # 使用配置中心
        service-id: config-server   # 配置中心服务名称

#注册Eureka
eureka:
  client:
    service-url:
      defaultZone: http://127.0.0.1:10086/eureka,http://127.0.0.1:10087/eureka<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>bootstrap.yml文件也是Spring Boot的默认配置文件</strong>，而且其加载的时间相比于application.yml更早。</p><p>application.yml和bootstrap.yml虽然都是Spring Boot的默认配置文件，但是定位却不相同。bootstrap.yml</p><p>可以理解成系统级别的一些参数配置，这些参数一般是不会变动的。application.yml 可以用来定义应用级别的</p><p>参数</p><p>总结就是，bootstrap.yml文件相当于项目启动时的引导文件，内容相对固定 能保证服务正常启动。application.yml文件是针对当前微服务 配置一些细节方面的东西 变化比较频繁。 他<strong>们两个文件是可以同时存在的</strong></p><p>那么有人会问了 bootstrap.yml文件内容是从 git 上获取 而 application.yml 是当前服务的配置文件</p><p>如果内容相同会不会冲突 ? 答案不会 bootstrap.yml 加载的时间相比于application.yml更早。 如果有些配置相同的话就会被覆盖配置 如果不同的话那么就使用application.yml里的配置</p><p>当服务中同时有bootstrap.yml application.yml时，application.yml中的端口则不会覆盖掉bootstrap.yml中的端口，也就是 默认使用的是bootstrap.yml的端口号</p><p>一般情况下 不建议同时使用 多个配置文件的 建议能使用bootstrap.yml就别使用application.yml 这样有利于管理 否则你修改配置文件到gitee仓库里改完 你还要到服务器里改</p><p>我们将user_service服务重启 <strong>(必须有网 否则启动失败)</strong></p><p><strong>这里注意:</strong> 如果发现重启服务后 端口号变成了8080(Tomcat默认端口号) 那么表示没有获取到gitee上的配置文件</p><p>解决办法重启config-server服务 然后我们在将user_service服务重启 就会发现获取到了</p><p>然后访问 <a href="http://127.0.0.1:10010/feign/user2" target="_blank" rel="noopener">http://127.0.0.1:10010/feign/user2</a> 发现没有什么问题 能访问成功</p><p>如果还是不行可能是访问不到 eureka里的config-server 那么试试这个办法 我们可以使用url来试试</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da84.png" alt=""></p><p>接下来 我们将其他所有微服务的配置文件都放入gitee 按照上面的步骤操作 在上面我们已经创建了仓库了所以只需要创建配置对应的配置文件 然后添加配置信息就行</p><p>先来看看我们现在的项目结构:</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da80.jpg" alt=""></p><p>我们user_service已经放入gitee中了 所以我们现在 还有</p><p>eureka-server ,eureka-server-1 ,feign-service,feign-service1-1,gateway-service,user_service1这些服务的配置文件都没放入gitee中</p><p><strong>这里注意:</strong> 一定不要改 eureka-server和eureka-server-1 注册中心的配置 还是使用原来的application.yml就行</p><p>因为你想一个问题 我把所有服务都关闭了 我如果启动eureka-server 此时 config-server还没有启动成功</p><p>就会造成eureka-server 获取gitee上配置信息失败 导致其他服务也都失败 你可能会想我先启动config-server在启动eureka-server</p><p>这样也不现实 应为没有eureka注册中心 那么config-server就是一个单独的服务无法和其他服务通讯提供配置</p><p>而我们后来在启动eureka-server 也是无法获取到gitee上的配置信息</p><p>既然使用<strong>配置中心</strong>来管理配置文件那么我们以后 在启动其他微服务 前必须保证eureka服务注册中心 必须启动了</p><p>然后还必须保证config-server配置中心 也启动了 这样 其他的微服务才能启动成功</p><p>启动顺序:eureka-server-&gt;config-server-&gt; 其他微服务</p><p>我在来演示一次user_service1服务的操作</p><p>在gitee上weifuwu-config(你上面创建的仓库) 创建配置文件user1-dev.yml</p><p>将user_service1里的application.yml配置文件内容都复制进去 然后 提交</p><p>查看我们weifuwu-config仓库</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da81.jpg" alt=""></p><p>然后我们在user_service1获取getee中的user1-dev.yml 配置信息</p><p>在user_service1中的pom.xml添加Maven依赖</p><pre class="line-numbers language-xml"><code class="language-xml">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>删除user_service1原来的配置文件application.yml 添加新的bootstrap.yml配置文件</p><pre class="line-numbers language-yml"><code class="language-yml">spring:
  cloud:
    config:
      name: user1     # 与远程仓库中的配置文件的application保持一致
      profile: dev   # 远程仓库中的配置文件的profile保持一致
      label: master   # 远程仓库中(分支名称)
      discovery:
        enabled: true  # 使用配置中心
        service-id: config-server   # 配置中心服务名称

#注册Eureka
eureka:
  client:
    service-url:
      defaultZone: http://127.0.0.1:10086/eureka,http://127.0.0.1:10087/eureka<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后重启user_service1 然后访问 <a href="http://127.0.0.1:10010/feign/user2" target="_blank" rel="noopener">http://127.0.0.1:10010/feign/user2</a> 发现没有什么问题 能访问成功</p><p>好了其他的 微服务也是这样的操作 自行更换</p><p>经过我们的不懈努力 终于把所有服务的配置文件都放入到了gitee中了</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da82.jpg" alt=""></p><p><strong>而且除了eureka-server服务外</strong> 每个服务的配置文件也都换成bootstrap.yml配置文件了</p><h3 id="消息总线"><a href="#消息总线" class="headerlink" title="消息总线"></a><strong>消息总线</strong></h3><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da86.jpg" alt=""></p><p>上面的案例会面临着新的问题 就是我们修改gitee中的配置文件内容 但是并不会立马生效 必须重启使用配置文件的那个服务才行</p><p>我们来测试下 看看 是不是这样的情况</p><p>在gitee user-dev和user-dev1 中添加</p><pre class="line-numbers language-yml"><code class="language-yml">test:
  name: huanmin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud//img/da85.jpg" alt=""></p><p>然后修改 user_service和user_service1 的UserController</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>user<span class="token punctuation">.</span>controller<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>user<span class="token punctuation">.</span>entity<span class="token punctuation">.</span>User<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>user<span class="token punctuation">.</span>service<span class="token punctuation">.</span>UserService<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Autowired<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Value<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>*<span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> UserService userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${test.name}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> String name<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/{id}"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> User <span class="token function">queryById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> Long id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"配置文件中的test.name = "</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        User user <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">queryById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> user<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后我们访问 <a href="http://127.0.0.1:10010/feign/user2" target="_blank" rel="noopener">http://127.0.0.1:10010/feign/user2</a></p><p>查看 user_service和 user_service1控制台有没有</p><blockquote><p>配置文件中的test.name = huanmin 这条信息</p></blockquote><p>然后我们修改 gitee user_service和user_service1 内name 值 为huanmin123</p><p>然后我们访问 <a href="http://127.0.0.1:10010/feign/user2" target="_blank" rel="noopener">http://127.0.0.1:10010/feign/user2</a></p><blockquote><p>可以发现获取到的还是: 配置文件中的test.name = huanmin 这条信息</p></blockquote><p>我们重启 user_service和 user_service1服务试试</p><blockquote><p>可以发现成功获取到: 配置文件中的test.name = huanmin123</p></blockquote><p>在项目上线后 如果 我们 重启服务肯定是不现实的 那么如何在不重启服务的情况下完成刷新配置文件呢?</p><p>可以使用<strong>Spring Cloud Bus</strong>来实现配置的自动更新(热部署)。</p><p>需要注意的是Spring Cloud Bus底层是基于RabbitMQ实现的，默认使用本地的消息队列服务，所以需要提前</p><p>启动本地RabbitMQ服务（<strong>安装RabbitMQ以后才有</strong>），如下：</p><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da83.jpg" alt=""></p><p>如果不会安装RabbitMQ 我博客里有教程自己找 如果使用的是Linux的话 一定要关闭防火墙</p><p>然后我们在config-server 里pom.xml添加</p><pre class="line-numbers language-xml"><code class="language-xml">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-bus<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-stream-binder-rabbit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后修改config-server 里 application.yml 内容</p><pre class="line-numbers language-yml"><code class="language-yml">#设置端口号
server:
  port: 12000

# 设置  服务名 config-server
spring:
  application:
    name: config-server
  cloud:
    config:
      server:
        git:
         uri: https://gitee.com/huanminabc/weifuwu-config  #码云 配置文件仓库地址
  # rabbitmq的配置信息；  我下面使用的是rabbitmq自带的默认配置
  rabbitmq:
    host: 127.0.0.1    #ip
    port: 5672   #端口 5672 固定端口
    username: guest   #账号
    password: guest  #密码
#注册Eureka
eureka:
  client:
    service-url:
      defaultZone: http://127.0.0.1:10086/eureka,http://127.0.0.1:10087/eureka

management:
  endpoints:
    web:
      exposure:
      # 暴露触发消息总线的地址 : xxx/actuator/bus-refresh   固定的访问方式
        include: "*"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们在user_service和user_service1 的pom.xml添加</p><pre class="line-numbers language-xml"><code class="language-xml">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-bus<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-stream-binder-rabbit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后我们在gitee配置文件里 user-dev.yml和user-dev1.yml里修改内容</p><pre class="line-numbers language-yml"><code class="language-yml"># 设置  服务名 为user-service
spring:
  application:
    name: user-service
  # 配置数据库 参数
  datasource:
    driver-class-name: com.mysql.jdbc.Driver
    url: jdbc:mysql://localhost:3306/springcloud
    username: root
    password: root
  # rabbitmq的配置信息；  我下面使用的是rabbitmq自带的默认配置
  rabbitmq:
    host: 127.0.0.1    #ip
    port: 5672   #端口 5672 固定端口
    username: guest   #账号
    password: guest  #密码  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后在user_service和user_service1的UserController里添加 <code>@RefreshScope</code> 刷新配置</p><p><strong>注意：自动刷新 只能刷新 @RefreshScope 注解下的配置，一些特殊配置，如数据库等，需要同样先设置数据库链接ConfigServer类，然后通过加 @RefreshScope 注解方式 否则还是需要重启服务的</strong></p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RefreshScope</span> <span class="token comment" spellcheck="true">//刷新配置</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ol><li><p>然后将我们修改后的服务都从新启动下</p></li><li><p>之后修改getee中 user-dev.yml和user-dev1.yml配置文件内的 test.name值为huanminabc</p></li><li><p>我们在来测试下: 我们访问 <a href="http://127.0.0.1:10010/feign/user2" target="_blank" rel="noopener">http://127.0.0.1:10010/feign/user2</a> 发现结果并没有刷新</p><p>因为我们需要向配置中心发生一条post刷新配置的请求 然后其他的服务才能刷新配置</p></li><li><p>使用其他软件:比如 Insomnia 、Postman 这些工具可以模拟浏览器发送各种请求</p><p>我使用的是 Insomnia 感觉还行</p><p>当然也可以使用java发送 我博客里有具体教程:<a href="http://boke.huitoushian.cn/undefined/58818.html#toc-heading-1">使用java发送get和post请求</a></p></li><li><p><strong>在工具内发生post请求</strong> 来访问 这条地址 <a href="http://127.0.0.1:12000/actuator/bus-refresh" target="_blank" rel="noopener">http://127.0.0.1:12000/actuator/bus-refresh</a></p><p><a href="http://127.0.0.1:12000" target="_blank" rel="noopener">http://127.0.0.1:12000</a> 是你要访问配置中心的地址和端口号</p><p>/actuator/bus-refresh 这个是固定的</p></li><li><p>上一步请求成功后 然后在访问 <a href="http://127.0.0.1:10010/feign/user2" target="_blank" rel="noopener">http://127.0.0.1:10010/feign/user2</a></p><p>查看控制台我们可以发现: 配置文件中的test.name = huanminabc 这条信息 那么就代表我们成功了</p></li></ol><p>只要使用 bootstrap.yml 从gitee 获取配置文件的服务都能配置消息总线 但是也不是每个都需要</p><p>像 gateway-service feign-service 这种 服务就没必要配置 因为 基本上都是万年不变的</p><p>而需要配置 消息总线的服务 是经常需要改变配置文件里的参数 而不能总是重启服务器吧 更具业务需求 后期在配置</p><h2 id="Spring-Cloud-体系技术综合应用概览图"><a href="#Spring-Cloud-体系技术综合应用概览图" class="headerlink" title="Spring Cloud 体系技术综合应用概览图"></a><strong>Spring Cloud</strong> <strong>体系技术综合应用概览图</strong></h2><p><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%96%87%E7%AB%A0/SpringCloud/img/da87.jpg" alt=""></p><p>以上所有 技术我们 在上面 都已经 一 一完成了</p><p>以上案例代码</p><p>链接：<a href="https://pan.baidu.com/s/1_k6IGo1u0znXqz93AHnxAQ" target="_blank" rel="noopener">https://pan.baidu.com/s/1_k6IGo1u0znXqz93AHnxAQ</a><br>提取码：1234</p><script>document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });</script></div><hr><div class="reprint" id="reprint-statement"><div class="reprint__author"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-user">文章作者: </i></span><span class="reprint-info"><a href="/about" rel="external nofollow noreferrer">胡安民</a></span></div><div class="reprint__type"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-link">文章链接: </i></span><span class="reprint-info"><a href="http://boke.huitoushian.cn/posts/62978.html">http://boke.huitoushian.cn/posts/62978.html</a></span></div><div class="reprint__notice"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-copyright">版权声明: </i></span><span class="reprint-info">本博客所有文章除特別声明外，均采用 <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a> 许可协议。转载请注明来源 <a href="/about" target="_blank">胡安民</a> !</span></div></div><script async defer>document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }</script><div class="tag_share" style="display:block"><div class="post-meta__tag-list" style="display:inline-block"><div class="article-tag"><a href="/tags/java/"><span class="chip bg-color">java</span> </a><a href="/tags/SpringCloud/"><span class="chip bg-color">SpringCloud</span></a></div></div><div class="post_share" style="zoom:80%;width:fit-content;display:inline-block;float:right;margin:-.15rem 0"><link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css"><div id="article-share"><div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div><script src="/libs/share/js/social-share.min.js"></script></div></div></div><style>#reward{margin:40px 0;text-align:center}#reward .reward-link{font-size:1.4rem;line-height:38px}#reward .btn-floating:hover{box-shadow:0 6px 12px rgba(0,0,0,.2),0 5px 15px rgba(0,0,0,.2)}#rewardModal{width:320px;height:350px}#rewardModal .reward-title{margin:15px auto;padding-bottom:5px}#rewardModal .modal-content{padding:10px}#rewardModal .close{position:absolute;right:15px;top:15px;color:rgba(0,0,0,.5);font-size:1.3rem;line-height:20px;cursor:pointer}#rewardModal .close:hover{color:#ef5350;transform:scale(1.3);-moz-transform:scale(1.3);-webkit-transform:scale(1.3);-o-transform:scale(1.3)}#rewardModal .reward-tabs{margin:0 auto;width:210px}.reward-tabs .tabs{height:38px;margin:10px auto;padding-left:0}.reward-content ul{padding-left:0!important}.reward-tabs .tabs .tab{height:38px;line-height:38px}.reward-tabs .tab a{color:#fff;background-color:#ccc}.reward-tabs .tab a:hover{background-color:#ccc;color:#fff}.reward-tabs .wechat-tab .active{color:#fff!important;background-color:#22ab38!important}.reward-tabs .alipay-tab .active{color:#fff!important;background-color:#019fe8!important}.reward-tabs .reward-img{width:210px;height:210px}</style><div id="reward"><a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a><div id="rewardModal" class="modal"><div class="modal-content"><a class="close modal-close"><i class="fas fa-times"></i></a><h4 class="reward-title">你的赏识是我前进的动力</h4><div class="reward-content"><div class="reward-tabs"><ul class="tabs row"><li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li><li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li></ul><div id="alipay"><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%88%91%E7%9A%84%E4%BA%8C%E7%BB%B4%E7%A0%81/zhifubao.png" class="reward-img" alt="支付宝打赏二维码"></div><div id="wechat"><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E6%88%91%E7%9A%84%E4%BA%8C%E7%BB%B4%E7%A0%81/weixin.png" class="reward-img" alt="微信打赏二维码"></div></div></div></div></div></div><script>$(function(){$(".tabs").tabs()})</script></div></div><style>.valine-card{margin:1.5rem auto}.valine-card .card-content{padding:20px 20px 5px 20px}#vcomments textarea{box-sizing:border-box;background:url(/medias/comment_bg.png) 100% 100% no-repeat}#vcomments p{margin:2px 2px 10px;font-size:1.05rem;line-height:1.78rem}#vcomments blockquote p{text-indent:.2rem}#vcomments a{padding:0 2px;color:#4cbf30;font-weight:500;text-decoration:none}#vcomments img{max-width:100%;height:auto;cursor:pointer}#vcomments ol li{list-style-type:decimal}#vcomments ol,ul{display:block;padding-left:2em;word-spacing:.05rem}#vcomments ul li,ol li{display:list-item;line-height:1.8rem;font-size:1rem}#vcomments ul li{list-style-type:disc}#vcomments ul ul li{list-style-type:circle}#vcomments table,td,th{padding:12px 13px;border:1px solid #dfe2e5}#vcomments table,td,th{border:0}table tr:nth-child(2n),thead{background-color:#fafafa}#vcomments table th{background-color:#f2f2f2;min-width:80px}#vcomments table td{min-width:80px}#vcomments h1{font-size:1.85rem;font-weight:700;line-height:2.2rem}#vcomments h2{font-size:1.65rem;font-weight:700;line-height:1.9rem}#vcomments h3{font-size:1.45rem;font-weight:700;line-height:1.7rem}#vcomments h4{font-size:1.25rem;font-weight:700;line-height:1.5rem}#vcomments h5{font-size:1.1rem;font-weight:700;line-height:1.4rem}#vcomments h6{font-size:1rem;line-height:1.3rem}#vcomments p{font-size:1rem;line-height:1.5rem}#vcomments hr{margin:12px 0;border:0;border-top:1px solid #ccc}#vcomments blockquote{margin:15px 0;border-left:5px solid #42b983;padding:1rem .8rem .3rem .8rem;color:#666;background-color:rgba(66,185,131,.1)}#vcomments pre{font-family:monospace,monospace;padding:1.2em;margin:.5em 0;background:#272822;overflow:auto;border-radius:.3em;tab-size:4}#vcomments code{font-family:monospace,monospace;padding:1px 3px;font-size:.92rem;color:#e96900;background-color:#f8f8f8;border-radius:2px}#vcomments pre code{font-family:monospace,monospace;padding:0;color:#e8eaf6;background-color:#272822}#vcomments pre[class*=language-]{padding:1.2em;margin:.5em 0}#vcomments code[class*=language-],pre[class*=language-]{color:#e8eaf6}#vcomments [type=checkbox]:not(:checked),[type=checkbox]:checked{position:inherit;margin-left:-1.3rem;margin-right:.4rem;margin-top:-1px;vertical-align:middle;left:unset;visibility:visible}#vcomments b,strong{font-weight:700}#vcomments dfn{font-style:italic}#vcomments small{font-size:85%}#vcomments cite{font-style:normal}#vcomments mark{background-color:#fcf8e3;padding:.2em}#vcomments table,td,th{padding:12px 13px;border:1px solid #dfe2e5}table tr:nth-child(2n),thead{background-color:#fafafa}#vcomments table th{background-color:#f2f2f2;min-width:80px}#vcomments table td{min-width:80px}#vcomments [type=checkbox]:not(:checked),[type=checkbox]:checked{position:inherit;margin-left:-1.3rem;margin-right:.4rem;margin-top:-1px;vertical-align:middle;left:unset;visibility:visible}</style><div class="card valine-card" data-aos="fade-up"><div class="comment_headling" style="font-size:20px;font-weight:700;position:relative;padding-left:20px;top:15px;padding-bottom:5px"><i class="fas fa-comments fa-fw" aria-hidden="true"></i> <span>评论</span></div><div id="vcomments" class="card-content" style="display:grid"></div></div><script src="/libs/valine/av-min.js"></script><script src="/libs/valine/Valine.min.js"></script><script>new Valine({el:"#vcomments",appId:"H1na1TiHc0PCHxUcPg64wiBB-gzGzoHsz",appKey:"fKG7vFI4NaMF92qsG4bxjG8q",notify:!1,verify:!1,visitor:!0,avatar:"mm",pageSize:"10",lang:"zh-cn",placeholder:"just go go"})</script><article id="prenext-posts" class="prev-next articles"><div class="row article-row"><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge left-badge text-color"><i class="fas fa-chevron-left"></i>&nbsp;上一篇</div><div class="card"><a href="/posts/18404.html"><div class="card-image"><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/featureimages/193.jpg" class="responsive-img" alt="初始SpringCloud微服务"> <span class="card-title">初始SpringCloud微服务</span></div></a><div class="card-content article-content"><div class="summary block-with-text">初始SpringCloud微服务 1.系统架构演变随着互联网的发展，网站应用的规模不断扩大。需求的激增，带来的是技术上的压力。系统架构也因此也不断的演进、升级、迭代。从单一应用，到垂直拆分，到分布式服务，到SOA，以及现在火热的微服务</div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i>2020-10-17 </span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/java-Spring%E5%AE%B6%E6%97%8F/" class="post-category">java-Spring家族</a></span></div></div><div class="card-action article-tags"><a href="/tags/java/"><span class="chip bg-color">java</span> </a><a href="/tags/SpringCloud/"><span class="chip bg-color">SpringCloud</span></a></div></div></div><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge right-badge text-color">下一篇&nbsp;<i class="fas fa-chevron-right"></i></div><div class="card"><a href="/posts/9509.html"><div class="card-image"><img src="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/loading.gif" data-original="http://img.huitoushian.cn/%E5%8D%9A%E5%AE%A2/%E8%BD%AE%E6%92%AD%E5%9B%BE%E5%92%8C%E6%96%87%E7%AB%A0%E9%9A%8F%E6%9C%BA%E5%9B%BE/featureimages/411.jpg" class="responsive-img" alt="IDEA安装和破解2020"> <span class="card-title">IDEA安装和破解2020</span></div></a><div class="card-content article-content"><div class="summary block-with-text">IDEA安装和破解2020 如果不会安装2020 IDEA可参考 IDEA安装和破解2019 我博客里有 安装2020.1之后 你需要有对应版本的破解包 jetbrains-agent.jar 链接：https://pan.baid</div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i>2020-10-06 </span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/IDEA/" class="post-category">IDEA</a></span></div></div><div class="card-action article-tags"><a href="/tags/IDEA/"><span class="chip bg-color">IDEA</span></a></div></div></div></div></article></div><script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script><script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script><script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script><script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script><style type="text/css">code[class*=language-],pre[class*=language-]{white-space:pre!important}</style></div><div id="toc-aside" class="expanded col l3 hide-on-med-and-down"><div class="toc-widget"><div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div><div id="toc-content"></div></div></div></div><div id="floating-toc-btn" class="hide-on-med-and-down"><a class="btn-floating btn-large bg-color"><i class="fas fa-list-ul"></i></a></div><script src="/libs/tocbot/tocbot.min.js"></script><script>$(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('h6'),
            headingSelector: 'h2, h3, h4 ,h5 ,h6'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4 ,h5 ,h6').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });</script></main><footer class="page-footer bg-color"><link rel="stylesheet" href="/libs/aplayer/APlayer.min.css"><style>.aplayer .aplayer-lrc p{font-size:12px;font-weight:700;line-height:16px!important}.aplayer .aplayer-lrc p.aplayer-lrc-current{font-size:15px;color:#42b983}.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body{left:-66px!important}.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover{left:0!important}</style><div><div class="row"><meting-js class="col l8 offset-l2 m10 offset-m1 s12" server="netease" type="playlist" id="2688981661" fixed="true" autoplay theme="#42b983" loop order="random" preload="auto" volume="0.7" list-folded="false"></meting-js></div></div><script src="/libs/aplayer/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><div class="container row center-align" style="margin-bottom:0!important"><div class="col s12 m8 l8 copy-right">Copyright&nbsp;&copy; <span id="year">2020</span> <a href="/about" target="_blank">胡安民</a><br><span id="busuanzi_container_site_pv">|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv" class="white-color"></span>&nbsp;次 </span><span id="busuanzi_container_site_uv">|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv" class="white-color"></span>&nbsp;人</span><br><br></div><div class="col s12 m4 l4 social-link social-statis"><a href="https://github.com/" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50"><i class="fab fa-github"></i> </a><a href="mailto:3426154361@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50"><i class="fas fa-envelope-open"></i> </a><a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=3426154361" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 3426154361" data-position="top" data-delay="50"><i class="fab fa-qq"></i> </a><a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50"><i class="fas fa-rss"></i></a></div></div></footer><div class="progress-bar"></div><div id="searchModal" class="modal"><div class="modal-content"><div class="search-header"><span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span> <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字" class="search-input"></div><div id="searchResult"></div></div></div><script src="/js/search.js"></script><script type="text/javascript">$(function(){searchFunc("/search.xml","searchInput","searchResult")})</script><div id="backTop" class="top-scroll"><a class="btn-floating btn-large waves-effect waves-light" href="#!"><i class="fas fa-arrow-up"></i></a></div><script src="/libs/materialize/materialize.min.js"></script><script src="/libs/masonry/masonry.pkgd.min.js"></script><script src="/libs/aos/aos.js"></script><script src="/libs/scrollprogress/scrollProgress.min.js"></script><script src="/libs/lightGallery/js/lightgallery-all.min.js"></script><script src="/js/matery.js"></script><script src="/js/click_show_text.js"></script><script type="text/javascript">var windowWidth=$(window).width();768<windowWidth&&document.write('<script type="text/javascript" src="/js/sakura.js"><\/script>')</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="/libs/others/clicklove.js" async></script><script async src="/libs/others/busuanzi.pure.mini.js"></script><script>!function(e,t,o,c,a,i,n){e.DaoVoiceObject=a,e[a]=e[a]||function(){(e[a].q=e[a].q||[]).push(arguments)},e[a].l=+new Date,i=t.createElement(o),n=t.getElementsByTagName(o)[0],i.async=1,i.src=c,i.charset="utf-8",n.parentNode.insertBefore(i,n)}(window,document,"script",("https:"==document.location.protocol?"https:":"http:")+"//widget.daovoice.io/widget/6984b559.js","daovoice"),daovoice("init",{app_id:"2966aa5c"}),daovoice("update")</script><script type="text/javascript" color="127,69,110" pointcolor="0,0,255" opacity="0.5" zindex="-1" count="200" src="/libs/background/canvas-nest.js"></script><script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async></script><script src="/libs/instantpage/instantpage.js" type="module"></script><script type="text/javascript">var st,OriginTitile=document.title;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="ヽ(●-`Д´-)ノ",clearTimeout(st)):(document.title="(Ő∀Ő3)ノ",st=setTimeout(function(){document.title=OriginTitile},3e3))})</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/z16.model.json"},display:{position:"left",width:165,height:335,hOffset:-10,vOffset:30},mobile:{show:!0,scale:.5},react:{opacity:.7},log:!1})</script><script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(n){n.imageLazyLoadSetting.processImages=i;var e=n.imageLazyLoadSetting.isSPA,r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function i(){e&&(r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));for(var t,a=0;a<r.length;a++)0<=(t=(t=r[a]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(n.innerHeight+240||document.documentElement.clientHeight+240)&&function(){var t,e,n,i,o=r[a];t=o,e=function(){r=r.filter(function(t){return o!==t})},n=new Image,i=t.getAttribute("data-original"),n.onload=function(){t.src=i,e&&e()},n.src=i}()}i(),n.addEventListener("scroll",function(){var t,e;t=i,e=n,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this);</script></body></html>